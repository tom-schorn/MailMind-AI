{% extends "base.html" %}

{% block title %}Edit Email Rule - MailMind AI{% endblock %}

{% block page_title %}Edit Email Rule{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('list_rules') }}">Email Rules</a></li>
<li class="breadcrumb-item active">Edit</li>
{% endblock %}

{% block content %}
<section class="section">
  <div class="row">
    <div class="col-lg-10">

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Edit Email Rule</h5>

          <form class="row g-3" method="POST" action="{{ url_for('edit_rule', id=rule.id) }}">
            <!-- Basic Fields -->
            <div class="col-md-12">
              <label for="email_account_id" class="form-label">Email Account</label>
              <select class="form-select" id="email_account_id" name="email_account_id" required>
                {% for account in accounts %}
                <option value="{{ account.id }}" {% if account.id == rule.email_credential_id %}selected{% endif %}>{{ account.email_address }} ({{ account.host }})</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-12">
              <label for="monitored_folder" class="form-label">Monitored Folder</label>
              <select class="form-select" id="monitored_folder" name="monitored_folder" required>
                <option value="{{ rule.monitored_folder if rule.monitored_folder else 'INBOX' }}" selected>
                  {{ rule.monitored_folder if rule.monitored_folder else 'INBOX' }}
                </option>
              </select>
              <div class="form-text">Select which folder to monitor for new emails</div>
            </div>

            <div class="col-md-8">
              <label for="name" class="form-label">Rule Name</label>
              <input type="text" class="form-control" id="name" name="name" value="{{ rule.name }}" required>
            </div>

            <div class="col-md-4">
              <label class="form-label">Enabled</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="enabled" name="enabled" {% if rule.enabled %}checked{% endif %}>
                <label class="form-check-label" for="enabled">
                  Rule is active
                </label>
              </div>
            </div>

            <div class="col-md-12">
              <label class="form-label">Condition Logic</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="logic" id="logic_and" value="AND" {% if rule.condition == 'AND' %}checked{% endif %}>
                <label class="form-check-label" for="logic_and">
                  AND (all conditions must match)
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="logic" id="logic_or" value="OR" {% if rule.condition == 'OR' %}checked{% endif %}>
                <label class="form-check-label" for="logic_or">
                  OR (at least one condition must match)
                </label>
              </div>
            </div>

            <!-- Conditions Section -->
            <div class="col-md-12">
              <hr>
              <h6>Conditions</h6>
              <div id="conditions-container">
                {% for cond in rule.conditions %}
                <div class="condition-row mb-2">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <select name="condition_field_{{ loop.index0 }}" class="form-select" required>
                        <option value="from" {% if cond.field == 'from' %}selected{% endif %}>From</option>
                        <option value="subject" {% if cond.field == 'subject' %}selected{% endif %}>Subject</option>
                        <option value="body" {% if cond.field == 'body' %}selected{% endif %}>Body</option>
                        <option value="to" {% if cond.field == 'to' %}selected{% endif %}>To</option>
                        <option value="header" {% if cond.field == 'header' %}selected{% endif %}>Header</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <select name="condition_operator_{{ loop.index0 }}" class="form-select" required>
                        <option value="contains" {% if cond.operator == 'contains' %}selected{% endif %}>contains</option>
                        <option value="equals" {% if cond.operator == 'equals' %}selected{% endif %}>equals</option>
                        <option value="not_equals" {% if cond.operator == 'not_equals' %}selected{% endif %}>not equals</option>
                        <option value="starts_with" {% if cond.operator == 'starts_with' %}selected{% endif %}>starts with</option>
                        <option value="ends_with" {% if cond.operator == 'ends_with' %}selected{% endif %}>ends with</option>
                        <option value="greater_than" {% if cond.operator == 'greater_than' %}selected{% endif %}>greater than</option>
                        <option value="less_than" {% if cond.operator == 'less_than' %}selected{% endif %}>less than</option>
                        <option value="greater_equal" {% if cond.operator == 'greater_equal' %}selected{% endif %}>greater or equal</option>
                        <option value="less_equal" {% if cond.operator == 'less_equal' %}selected{% endif %}>less or equal</option>
                        <option value="date_older_than" {% if cond.operator == 'date_older_than' %}selected{% endif %}>date older than (days)</option>
                      </select>
                    </div>
                    <div class="col-md-5">
                      <input type="text" name="condition_value_{{ loop.index0 }}" class="form-control" placeholder="Value" value="{{ cond.value }}" required>
                    </div>
                    <div class="col-md-1">
                      <button type="button" class="btn btn-danger btn-sm" onclick="removeCondition(this)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              <button type="button" class="btn btn-sm btn-secondary" onclick="addCondition()">
                <i class="bi bi-plus-circle"></i> Add Condition
              </button>
            </div>

            <!-- Actions Section -->
            <div class="col-md-12">
              <hr>
              <h6>Actions</h6>
              <div id="actions-container">
                {% for action in rule.rule_actions %}
                <div class="action-row mb-2">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <select name="action_type_{{ loop.index0 }}" class="form-select action-type-select" required onchange="toggleActionFields(this)">
                        <option value="move_to_folder" {% if action.action_type == 'move_to_folder' %}selected{% endif %}>Move to Folder</option>
                        <option value="copy_to_folder" {% if action.action_type == 'copy_to_folder' %}selected{% endif %}>Copy to Folder</option>
                        <option value="add_label" {% if action.action_type == 'add_label' %}selected{% endif %}>Add Label</option>
                        <option value="mark_as_read" {% if action.action_type == 'mark_as_read' %}selected{% endif %}>Mark as Read</option>
                        <option value="delete" {% if action.action_type == 'delete' %}selected{% endif %}>Delete</option>
                        <option value="modify_subject" {% if action.action_type == 'modify_subject' %}selected{% endif %}>Modify Subject</option>
                      </select>
                    </div>
                    <div class="col-md-8">
                      <input type="text" name="action_value_{{ loop.index0 }}" class="form-control action-value" placeholder="Folder/Label/Subject Pattern" value="{{ action.action_value }}">
                    </div>
                    <div class="col-md-1">
                      <button type="button" class="btn btn-danger btn-sm" onclick="removeAction(this)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              <button type="button" class="btn btn-sm btn-secondary" onclick="addAction()">
                <i class="bi bi-plus-circle"></i> Add Action
              </button>
            </div>

            <div class="text-center">
              <button type="button" class="btn btn-info" onclick="testRule()">
                <i class="bi bi-play-circle"></i> Test Rule (Dry-Run)
              </button>
              <button type="submit" class="btn btn-primary">Update Rule</button>
              <a href="{{ url_for('list_rules') }}" class="btn btn-secondary">Cancel</a>
            </div>
          </form>

        </div>
      </div>

      <!-- Test Results Section -->
      <div class="card mt-3" id="test-results-card" style="display: none;">
        <div class="card-body">
          <h5 class="card-title">Test Results</h5>
          <div id="test-status" class="alert alert-info" style="display: none;">
            <i class="bi bi-hourglass-split"></i> Testing...
          </div>
          <div id="test-error" class="alert alert-danger" style="display: none;"></div>
          <div id="test-results-content"></div>
        </div>
      </div>

    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
let conditionIndex = {{ rule.conditions|length }};
let actionIndex = {{ rule.rule_actions|length }};

function addCondition() {
  const html = `
    <div class="condition-row mb-2">
      <div class="row g-2">
        <div class="col-md-3">
          <select name="condition_field_${conditionIndex}" class="form-select" required>
            <option value="from">From</option>
            <option value="subject">Subject</option>
            <option value="body">Body</option>
            <option value="to">To</option>
            <option value="header">Header</option>
          </select>
        </div>
        <div class="col-md-3">
          <select name="condition_operator_${conditionIndex}" class="form-select" required>
            <option value="contains">contains</option>
            <option value="equals">equals</option>
            <option value="not_equals">not equals</option>
            <option value="starts_with">starts with</option>
            <option value="ends_with">ends with</option>
            <option value="greater_than">greater than</option>
            <option value="less_than">less than</option>
            <option value="greater_equal">greater or equal</option>
            <option value="less_equal">less or equal</option>
            <option value="date_older_than">date older than (days)</option>
          </select>
        </div>
        <div class="col-md-5">
          <input type="text" name="condition_value_${conditionIndex}" class="form-control" placeholder="Value" required>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-danger btn-sm" onclick="removeCondition(this)">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('conditions-container').insertAdjacentHTML('beforeend', html);
  conditionIndex++;
}

function removeCondition(button) {
  const container = document.getElementById('conditions-container');
  if (container.children.length > 1) {
    button.closest('.condition-row').remove();
  } else {
    alert('At least one condition is required.');
  }
}

function addAction() {
  const html = `
    <div class="action-row mb-2">
      <div class="row g-2">
        <div class="col-md-3">
          <select name="action_type_${actionIndex}" class="form-select action-type-select" required onchange="toggleActionFields(this)">
            <option value="move_to_folder">Move to Folder</option>
            <option value="copy_to_folder">Copy to Folder</option>
            <option value="add_label">Add Label</option>
            <option value="mark_as_read">Mark as Read</option>
            <option value="delete">Delete</option>
            <option value="modify_subject">Modify Subject</option>
          </select>
        </div>
        <div class="col-md-8">
          <input type="text" name="action_value_${actionIndex}" class="form-control action-value" placeholder="Folder/Label/Subject Pattern" required>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-danger btn-sm" onclick="removeAction(this)">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('actions-container').insertAdjacentHTML('beforeend', html);
  actionIndex++;
}

function removeAction(button) {
  const container = document.getElementById('actions-container');
  if (container.children.length > 1) {
    button.closest('.action-row').remove();
  } else {
    alert('At least one action is required.');
  }
}

function toggleActionFields(select) {
  const row = select.closest('.action-row');
  const valueInput = row.querySelector('.action-value');
  const actionType = select.value;

  if (actionType === 'mark_as_read' || actionType === 'delete') {
    valueInput.style.display = 'none';
    valueInput.removeAttribute('required');
  } else {
    valueInput.style.display = 'block';
    valueInput.setAttribute('required', 'required');

    // Update placeholder
    if (actionType === 'move_to_folder' || actionType === 'copy_to_folder') {
      valueInput.placeholder = 'Folder path (e.g., INBOX/Spam)';
    } else if (actionType === 'add_label') {
      valueInput.placeholder = 'Label name';
    } else if (actionType === 'modify_subject') {
      valueInput.placeholder = 'New subject pattern';
    }
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.action-type-select').forEach(select => {
    toggleActionFields(select);
  });
});

function testRule() {
  const credentialId = document.getElementById('email_account_id').value;
  if (!credentialId) {
    alert('Please select an email account first.');
    return;
  }

  const logic = document.querySelector('input[name="logic"]:checked').value;

  const conditions = [];
  document.querySelectorAll('.condition-row').forEach((row, index) => {
    const field = row.querySelector(`select[name^="condition_field_"]`).value;
    const operator = row.querySelector(`select[name^="condition_operator_"]`).value;
    const value = row.querySelector(`input[name^="condition_value_"]`).value;
    conditions.push({ field, operator, value });
  });

  const actions = [];
  document.querySelectorAll('.action-row').forEach((row, index) => {
    const actionType = row.querySelector(`select[name^="action_type_"]`).value;
    const actionValue = row.querySelector(`input[name^="action_value_"]`).value || '';
    actions.push({ action_type: actionType, action_value: actionValue });
  });

  document.getElementById('test-results-card').style.display = 'block';
  document.getElementById('test-status').style.display = 'block';
  document.getElementById('test-error').style.display = 'none';
  document.getElementById('test-results-content').innerHTML = '';

  const startTime = Date.now();
  const progressInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('test-progress').textContent = `Testing... (${elapsed}s elapsed)`;
  }, 1000);

  fetch('/rules/test-preview', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      credential_id: parseInt(credentialId),
      logic: logic,
      conditions: conditions,
      actions: actions,
      max_emails: 10
    })
  })
  .then(response => response.json())
  .then(data => {
    clearInterval(progressInterval);
    document.getElementById('test-status').style.display = 'none';

    if (data.error) {
      document.getElementById('test-error').style.display = 'block';
      document.getElementById('test-error').textContent = 'Error: ' + data.error;
      return;
    }

    const results = data.results;
    const emailsChecked = data.emails_checked || 'N/A';
    const totalEmails = data.total_emails || 'N/A';
    const inboxTotal = data.inbox_total || 'N/A';

    let html = `
      <div class="alert alert-info">
        <strong>Matching Emails:</strong> ${results.length} / 10 max<br>
        <strong>Emails Checked:</strong> ${emailsChecked} / ${totalEmails} (Inbox total: ${inboxTotal})
      </div>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Subject</th>
            <th>From</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
    `;

    if (results.length === 0) {
      html += `
        <tr>
          <td colspan="4" class="text-center">No matching emails found.</td>
        </tr>
      `;
    }

    results.forEach((result, index) => {
      html += `
        <tr>
          <td>${result.email_subject.substring(0, 50)}${result.email_subject.length > 50 ? '...' : ''}</td>
          <td>${result.email_from}</td>
          <td>${result.email_date}</td>
          <td>
            <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse"
                    data-bs-target="#details-${index}">
              <i class="bi bi-eye"></i> View
            </button>
          </td>
        </tr>
        <tr class="collapse" id="details-${index}">
          <td colspan="4">
            <div class="card card-body">
              <h6>Condition Results:</h6>
      `;

      result.condition_results.forEach(cond => {
        html += `
          <div class="mb-2">
            <strong>${cond.field}</strong> ${cond.operator} "${cond.value}":
            ${cond.matched ?
              '<span class="badge bg-success">Matched</span>' :
              '<span class="badge bg-secondary">Not Matched</span>'}
            <br>
            <small class="text-muted">${cond.reason}</small>
          </div>
        `;
      });

      if (result.matched && result.actions_would_apply.length > 0) {
        html += `
          <h6 class="mt-3">Actions that would be applied:</h6>
          <ul>
        `;
        result.actions_would_apply.forEach(action => {
          html += `<li>${action}</li>`;
        });
        html += `</ul>`;
      }

      html += `
            </div>
          </td>
        </tr>
      `;
    });

    html += `
        </tbody>
      </table>
    `;

    document.getElementById('test-results-content').innerHTML = html;
  })
  .catch(error => {
    clearInterval(progressInterval);
    document.getElementById('test-status').style.display = 'none';
    document.getElementById('test-error').style.display = 'block';
    document.getElementById('test-error').textContent = 'Error: ' + error.message;
  });
}

// Load folders on page load
const credentialId = {{ rule.email_credential_id }};
const currentFolder = "{{ rule.monitored_folder if rule.monitored_folder else 'INBOX' }}";

fetch(`/api/folders/${credentialId}`)
  .then(r => r.json())
  .then(data => {
    if (data.error) {
      console.error('Error loading folders:', data.error);
      return;
    }

    const folderSelect = document.getElementById('monitored_folder');
    folderSelect.innerHTML = '';

    data.folders.forEach(folder => {
      if (folder.selectable) {
        const option = document.createElement('option');
        option.value = folder.name;
        option.textContent = folder.name;
        if (folder.name === currentFolder) {
          option.selected = true;
        }
        folderSelect.appendChild(option);
      }
    });
  })
  .catch(err => console.error('Error loading folders:', err));
</script>
{% endblock %}
