{% extends "base.html" %}

{% block title %}Add Email Rule - MailMind AI{% endblock %}

{% block page_title %}Add Email Rule{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('list_rules') }}">Email Rules</a></li>
<li class="breadcrumb-item active">Add</li>
{% endblock %}

{% block content %}
<section class="section">
  <div class="row">
    <div class="col-lg-10">

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">New Email Rule</h5>

          <form class="row g-3" method="POST" action="{{ url_for('add_rule') }}">
            <!-- Basic Fields -->
            <div class="col-md-12">
              <label for="email_account_id" class="form-label">Email Account</label>
              <select class="form-select" id="email_account_id" name="email_account_id" required>
                <option value="">Select an email account...</option>
                {% for account in accounts %}
                <option value="{{ account.id }}">{{ account.email_address }} ({{ account.host }})</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-12" id="monitored-folder-group" style="display: none;">
              <label for="monitored_folder" class="form-label">Monitored Folder</label>
              <select class="form-select" id="monitored_folder" name="monitored_folder" required>
                <option value="INBOX" selected>INBOX</option>
              </select>
              <div class="form-text">Select which folder to monitor for new emails</div>
            </div>

            <div class="col-md-8">
              <label for="name" class="form-label">Rule Name</label>
              <input type="text" class="form-control" id="name" name="name" required>
            </div>

            <div class="col-md-4">
              <label class="form-label">Enabled</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="enabled" name="enabled" checked>
                <label class="form-check-label" for="enabled">
                  Rule is active
                </label>
              </div>
            </div>

            <div class="col-md-12">
              <label class="form-label">Condition Logic</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="logic" id="logic_and" value="AND" checked>
                <label class="form-check-label" for="logic_and">
                  AND (all conditions must match)
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="logic" id="logic_or" value="OR">
                <label class="form-check-label" for="logic_or">
                  OR (at least one condition must match)
                </label>
              </div>
            </div>

            <!-- Conditions Section -->
            <div class="col-md-12">
              <hr>
              <h6>Conditions</h6>
              <div id="conditions-container">
                <div class="condition-row mb-2">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <select name="condition_field_0" class="form-select condition-field-select" required onchange="onConditionFieldChange(this)">
                        <option value="from">From</option>
                        <option value="subject">Subject</option>
                        <option value="body">Body</option>
                        <option value="to">To</option>
                        <option value="header">Header</option>
                        <option value="date">Date</option>
                        <option value="label">Label</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <select name="condition_operator_0" class="form-select condition-operator-select" required>
                        <option value="contains">contains</option>
                        <option value="equals">equals</option>
                        <option value="not_equals">not equals</option>
                        <option value="starts_with">starts with</option>
                        <option value="ends_with">ends with</option>
                        <option value="greater_than">greater than</option>
                        <option value="less_than">less than</option>
                        <option value="greater_equal">greater or equal</option>
                        <option value="less_equal">less or equal</option>
                        <option value="date_older_than">older than (days)</option>
                        <option value="date_before">before (date)</option>
                      </select>
                    </div>
                    <div class="col-md-5">
                      <input type="text" name="condition_value_0" class="form-control condition-value-input" placeholder="Value" required>
                    </div>
                    <div class="col-md-1">
                      <button type="button" class="btn btn-danger btn-sm" onclick="removeCondition(this)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-secondary" onclick="addCondition()">
                <i class="bi bi-plus-circle"></i> Add Condition
              </button>
            </div>

            <!-- Actions Section -->
            <div class="col-md-12">
              <hr>
              <h6>Actions</h6>
              <div id="actions-container">
                <div class="action-row mb-2">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <select name="action_type_0" class="form-select action-type-select" required onchange="toggleActionFields(this)">
                        <option value="move_to_folder">Move to Folder</option>
                        <option value="copy_to_folder">Copy to Folder</option>
                        <option value="add_label">Add Label</option>
                        <option value="mark_as_read">Mark as Read</option>
                        <option value="delete">Delete</option>
                        <option value="modify_subject">Modify Subject</option>
                      </select>
                    </div>
                    <div class="col-md-8">
                      <input type="text" name="action_value_0" class="form-control action-value" placeholder="Folder/Label/Subject Pattern" required>
                    </div>
                    <div class="col-md-1">
                      <button type="button" class="btn btn-danger btn-sm" onclick="removeAction(this)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-secondary" onclick="addAction()">
                <i class="bi bi-plus-circle"></i> Add Action
              </button>
            </div>

            <div class="text-center">
              <button type="button" class="btn btn-info" onclick="testRule()">
                <i class="bi bi-play-circle"></i> Test Rule (Dry-Run)
              </button>
              <button type="submit" class="btn btn-primary">Save Rule</button>
              <a href="{{ url_for('list_rules') }}" class="btn btn-secondary">Cancel</a>
            </div>
          </form>

        </div>
      </div>

      <!-- Test Log Modal -->
      <div class="modal fade" id="testLogModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Test Progress</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2">
                <strong>Status:</strong> <span id="modal-status">Testing...</span>
                <span id="modal-timer" class="text-muted ms-2">(0s)</span>
              </div>
              <div class="mb-2">
                <strong>Progress:</strong> <span id="modal-progress">0 emails checked</span>
              </div>
              <div style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                <div id="log-output"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Test Results Section -->
      <div class="card mt-3" id="test-results-card" style="display: none;">
        <div class="card-body">
          <h5 class="card-title">Test Results</h5>
          <div id="test-status" class="alert alert-info" style="display: none;">
            <i class="bi bi-hourglass-split"></i> <span id="test-progress">Testing...</span>
          </div>
          <div id="test-error" class="alert alert-danger" style="display: none;"></div>
          <div id="test-results-content"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Create Label Modal -->
  <div class="modal fade" id="createLabelModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Label</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="new-label-name" class="form-label">Label Name</label>
            <input type="text" class="form-control" id="new-label-name" required>
          </div>
          <div class="mb-3">
            <label for="new-label-color" class="form-label">Color</label>
            <input type="color" class="form-control form-control-color" id="new-label-color" value="#0d6efd">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveNewLabel()">Create</button>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
let conditionIndex = 1;
let actionIndex = 1;
let cachedFolders = null;
let cachedCredentialId = null;

function fetchFoldersIfNeeded(credentialId) {
  if (cachedFolders && cachedCredentialId === credentialId) {
    return Promise.resolve(cachedFolders);
  }
  return fetch(`/api/folders/${credentialId}`)
    .then(r => r.json())
    .then(data => {
      if (data.error) throw data.error;
      cachedFolders = data.folders;
      cachedCredentialId = credentialId;
      return data.folders;
    });
}

let cachedLabels = null;
let labelTargetElement = null;

function fetchLabelsIfNeeded(credentialId) {
  if (cachedLabels && cachedCredentialId === credentialId) {
    return Promise.resolve(cachedLabels);
  }
  return fetch(`/api/labels/${credentialId}`)
    .then(r => r.json())
    .then(data => {
      if (data.error) throw data.error;
      cachedLabels = data.labels;
      return data.labels;
    });
}

function buildLabelSelect(inputName, currentValue, onChange) {
  const credentialId = document.getElementById('email_account_id').value;
  if (!credentialId) return null;

  const sel = document.createElement('select');
  sel.name = inputName;
  sel.className = 'form-select condition-value-input';
  sel.required = true;
  if (onChange) sel.addEventListener('change', onChange);

  fetchLabelsIfNeeded(credentialId).then(labels => {
    sel.innerHTML = '';
    labels.forEach(label => {
      const opt = document.createElement('option');
      opt.value = label.name;
      opt.textContent = label.name;
      if (label.name === currentValue) opt.selected = true;
      sel.appendChild(opt);
    });
    const createOpt = document.createElement('option');
    createOpt.value = '__create_new__';
    createOpt.textContent = '+ Create New Label...';
    sel.appendChild(createOpt);
  });

  return sel;
}

function buildLabelSelectForAction(inputName, currentValue) {
  const credentialId = document.getElementById('email_account_id').value;
  if (!credentialId) return null;

  const sel = document.createElement('select');
  sel.name = inputName;
  sel.className = 'form-select action-value';
  sel.required = true;

  fetchLabelsIfNeeded(credentialId).then(labels => {
    sel.innerHTML = '';
    labels.forEach(label => {
      const opt = document.createElement('option');
      opt.value = label.name;
      opt.textContent = label.name;
      if (label.name === currentValue) opt.selected = true;
      sel.appendChild(opt);
    });
    const createOpt = document.createElement('option');
    createOpt.value = '__create_new__';
    createOpt.textContent = '+ Create New Label...';
    sel.appendChild(createOpt);
  });

  sel.addEventListener('change', function() {
    if (this.value === '__create_new__') {
      labelTargetElement = this;
      new bootstrap.Modal(document.getElementById('createLabelModal')).show();
    }
  });

  return sel;
}

function saveNewLabel() {
  const credentialId = document.getElementById('email_account_id').value;
  const name = document.getElementById('new-label-name').value.trim();
  const color = document.getElementById('new-label-color').value;

  if (!name) { alert('Please enter a label name.'); return; }
  if (!credentialId) { alert('Please select an email account first.'); return; }

  fetch(`/api/labels/${credentialId}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({name: name, color: color})
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) { alert('Error: ' + data.error); return; }

    cachedLabels = null;
    bootstrap.Modal.getInstance(document.getElementById('createLabelModal')).hide();
    document.getElementById('new-label-name').value = '';

    if (labelTargetElement) {
      const targetSelect = labelTargetElement;
      const inputName = targetSelect.name;
      const isAction = targetSelect.classList.contains('action-value');

      fetchLabelsIfNeeded(credentialId).then(labels => {
        targetSelect.innerHTML = '';
        labels.forEach(label => {
          const opt = document.createElement('option');
          opt.value = label.name;
          opt.textContent = label.name;
          if (label.name === name) opt.selected = true;
          targetSelect.appendChild(opt);
        });
        const createOpt = document.createElement('option');
        createOpt.value = '__create_new__';
        createOpt.textContent = '+ Create New Label...';
        targetSelect.appendChild(createOpt);
      });
      labelTargetElement = null;
    }
  })
  .catch(err => alert('Error creating label: ' + err));
}

const standardOperators = [
  {value: 'contains', text: 'contains'},
  {value: 'equals', text: 'equals'},
  {value: 'not_equals', text: 'not equals'},
  {value: 'starts_with', text: 'starts with'},
  {value: 'ends_with', text: 'ends with'},
  {value: 'greater_than', text: 'greater than'},
  {value: 'less_than', text: 'less than'},
  {value: 'greater_equal', text: 'greater or equal'},
  {value: 'less_equal', text: 'less or equal'},
  {value: 'date_older_than', text: 'older than (days)'},
  {value: 'date_before', text: 'before (date)'}
];

const dateOperators = [
  {value: 'date_older_than', text: 'older than (days)'},
  {value: 'date_before', text: 'before (date)'}
];

const labelOperators = [
  {value: 'has_label', text: 'has label'},
  {value: 'not_has_label', text: 'does not have label'}
];

function onConditionFieldChange(fieldSelect) {
  const row = fieldSelect.closest('.condition-row');
  const operatorSelect = row.querySelector('.condition-operator-select');
  const valueContainer = row.querySelector('.col-md-5');
  const field = fieldSelect.value;
  const valueName = valueContainer.querySelector('[name^="condition_value_"]').name;

  let operators;
  if (field === 'date') {
    operators = dateOperators;
  } else if (field === 'label') {
    operators = labelOperators;
  } else {
    operators = standardOperators;
  }

  operatorSelect.innerHTML = '';
  operators.forEach(op => {
    const option = document.createElement('option');
    option.value = op.value;
    option.textContent = op.text;
    operatorSelect.appendChild(option);
  });

  updateConditionValueInput(row);
}

function updateConditionValueInput(row) {
  const operatorSelect = row.querySelector('.condition-operator-select');
  const valueContainer = row.querySelector('.col-md-5');
  const operator = operatorSelect.value;
  const existingInput = valueContainer.querySelector('[name^="condition_value_"]');
  const inputName = existingInput.name;
  const fieldSelect = row.querySelector('.condition-field-select');
  const field = fieldSelect ? fieldSelect.value : '';

  if (operator === 'date_before') {
    if (existingInput.type !== 'date') {
      const dateInput = document.createElement('input');
      dateInput.type = 'date';
      dateInput.name = inputName;
      dateInput.className = 'form-control condition-value-input';
      dateInput.required = true;
      existingInput.replaceWith(dateInput);
    }
  } else if (field === 'label') {
    const sel = buildLabelSelect(inputName, existingInput.value, function() {
      if (this.value === '__create_new__') {
        labelTargetElement = this;
        new bootstrap.Modal(document.getElementById('createLabelModal')).show();
      }
    });
    if (sel) {
      existingInput.replaceWith(sel);
    }
  } else {
    if (existingInput.type !== 'text' || existingInput.tagName !== 'INPUT') {
      const textInput = document.createElement('input');
      textInput.type = 'text';
      textInput.name = inputName;
      textInput.className = 'form-control condition-value-input';
      textInput.placeholder = operator === 'date_older_than' ? 'Days (e.g. 30)' : 'Value';
      textInput.required = true;
      existingInput.replaceWith(textInput);
    } else {
      existingInput.placeholder = operator === 'date_older_than' ? 'Days (e.g. 30)' : 'Value';
    }
  }
}

function addCondition() {
  const html = `
    <div class="condition-row mb-2">
      <div class="row g-2">
        <div class="col-md-3">
          <select name="condition_field_${conditionIndex}" class="form-select condition-field-select" required onchange="onConditionFieldChange(this)">
            <option value="from">From</option>
            <option value="subject">Subject</option>
            <option value="body">Body</option>
            <option value="to">To</option>
            <option value="header">Header</option>
            <option value="date">Date</option>
            <option value="label">Label</option>
          </select>
        </div>
        <div class="col-md-3">
          <select name="condition_operator_${conditionIndex}" class="form-select condition-operator-select" required>
            <option value="contains">contains</option>
            <option value="equals">equals</option>
            <option value="not_equals">not equals</option>
            <option value="starts_with">starts with</option>
            <option value="ends_with">ends with</option>
            <option value="greater_than">greater than</option>
            <option value="less_than">less than</option>
            <option value="greater_equal">greater or equal</option>
            <option value="less_equal">less or equal</option>
            <option value="date_older_than">older than (days)</option>
            <option value="date_before">before (date)</option>
          </select>
        </div>
        <div class="col-md-5">
          <input type="text" name="condition_value_${conditionIndex}" class="form-control condition-value-input" placeholder="Value" required>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-danger btn-sm" onclick="removeCondition(this)">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('conditions-container').insertAdjacentHTML('beforeend', html);
  conditionIndex++;
}

function removeCondition(button) {
  const container = document.getElementById('conditions-container');
  if (container.children.length > 1) {
    button.closest('.condition-row').remove();
  } else {
    alert('At least one condition is required.');
  }
}

function addAction() {
  const html = `
    <div class="action-row mb-2">
      <div class="row g-2">
        <div class="col-md-3">
          <select name="action_type_${actionIndex}" class="form-select action-type-select" required onchange="toggleActionFields(this)">
            <option value="move_to_folder">Move to Folder</option>
            <option value="copy_to_folder">Copy to Folder</option>
            <option value="add_label">Add Label</option>
            <option value="mark_as_read">Mark as Read</option>
            <option value="delete">Delete</option>
            <option value="modify_subject">Modify Subject</option>
          </select>
        </div>
        <div class="col-md-8">
          <input type="text" name="action_value_${actionIndex}" class="form-control action-value" placeholder="Folder/Label/Subject Pattern" required>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-danger btn-sm" onclick="removeAction(this)">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('actions-container').insertAdjacentHTML('beforeend', html);
  actionIndex++;
  // Init the new action row - default is move_to_folder, so load folder select
  const newRow = document.getElementById('actions-container').lastElementChild;
  toggleActionFields(newRow.querySelector('.action-type-select'));
}

function removeAction(button) {
  const container = document.getElementById('actions-container');
  if (container.children.length > 1) {
    button.closest('.action-row').remove();
  } else {
    alert('At least one action is required.');
  }
}

function toggleActionFields(select) {
  const row = select.closest('.action-row');
  const valueContainer = row.querySelector('.col-md-8');
  const existingEl = valueContainer.querySelector('.action-value');
  const actionType = select.value;
  const elName = existingEl.name;
  const currentValue = existingEl.value;

  if (actionType === 'mark_as_read' || actionType === 'delete') {
    if (existingEl.tagName === 'SELECT') {
      const input = document.createElement('input');
      input.type = 'text';
      input.name = elName;
      input.className = 'form-control action-value';
      existingEl.replaceWith(input);
    }
    const el = valueContainer.querySelector('.action-value');
    el.style.display = 'none';
    el.removeAttribute('required');
    el.value = '';
  } else if (actionType === 'move_to_folder' || actionType === 'copy_to_folder') {
    const credentialId = document.getElementById('email_account_id').value;
    if (credentialId) {
      fetchFoldersIfNeeded(credentialId).then(folders => {
        const sel = document.createElement('select');
        sel.name = elName;
        sel.className = 'form-select action-value';
        sel.required = true;
        folders.forEach(folder => {
          if (folder.selectable) {
            const opt = document.createElement('option');
            opt.value = folder.name;
            opt.textContent = folder.name;
            if (folder.name === currentValue) opt.selected = true;
            sel.appendChild(opt);
          }
        });
        existingEl.replaceWith(sel);
      });
    } else {
      if (existingEl.tagName === 'SELECT') {
        const input = document.createElement('input');
        input.type = 'text';
        input.name = elName;
        input.className = 'form-control action-value';
        input.placeholder = 'Folder path (e.g., INBOX/Spam)';
        input.required = true;
        input.value = currentValue;
        existingEl.replaceWith(input);
      } else {
        existingEl.style.display = 'block';
        existingEl.setAttribute('required', 'required');
        existingEl.placeholder = 'Folder path (e.g., INBOX/Spam)';
      }
    }
  } else if (actionType === 'add_label') {
    const credentialId = document.getElementById('email_account_id').value;
    if (credentialId) {
      const labelSel = buildLabelSelectForAction(elName, currentValue);
      if (labelSel) {
        existingEl.replaceWith(labelSel);
        return;
      }
    }
    if (existingEl.tagName === 'SELECT') {
      const input = document.createElement('input');
      input.type = 'text';
      input.name = elName;
      input.className = 'form-control action-value';
      input.placeholder = 'Label name';
      input.required = true;
      input.value = currentValue;
      existingEl.replaceWith(input);
    } else {
      existingEl.style.display = 'block';
      existingEl.setAttribute('required', 'required');
      existingEl.placeholder = 'Label name';
    }
  } else {
    if (existingEl.tagName === 'SELECT') {
      const input = document.createElement('input');
      input.type = 'text';
      input.name = elName;
      input.className = 'form-control action-value';
      input.required = true;
      input.value = currentValue;
      existingEl.replaceWith(input);
    }
    const el = valueContainer.querySelector('.action-value');
    el.style.display = 'block';
    el.setAttribute('required', 'required');
    if (actionType === 'modify_subject') {
      el.placeholder = 'New subject pattern';
    } else {
      el.placeholder = 'Value';
    }
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.action-type-select').forEach(select => {
    toggleActionFields(select);
  });
  document.querySelectorAll('.condition-field-select').forEach(select => {
    onConditionFieldChange(select);
  });
  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('condition-operator-select')) {
      updateConditionValueInput(e.target.closest('.condition-row'));
    }
  });
});

// Load folders when account is selected
document.getElementById('email_account_id').addEventListener('change', function() {
  const credentialId = this.value;
  const folderSelect = document.getElementById('monitored_folder');
  const folderGroup = document.getElementById('monitored-folder-group');

  if (!credentialId) {
    folderSelect.innerHTML = '<option value="INBOX">INBOX</option>';
    folderGroup.style.display = 'none';
    cachedFolders = null;
    cachedCredentialId = null;
    // Reset action folder selects back to text inputs
    document.querySelectorAll('.action-type-select').forEach(s => toggleActionFields(s));
    return;
  }

  // Invalidate cache on account change
  if (cachedCredentialId !== credentialId) {
    cachedFolders = null;
    cachedCredentialId = null;
  }

  folderSelect.innerHTML = '<option value="INBOX">Loading...</option>';

  fetchFoldersIfNeeded(credentialId).then(folders => {
    folderSelect.innerHTML = '';
    folders.forEach(folder => {
      if (folder.selectable) {
        const option = document.createElement('option');
        option.value = folder.name;
        option.textContent = folder.name;
        if (folder.name === 'INBOX') {
          option.selected = true;
        }
        folderSelect.appendChild(option);
      }
    });
    folderGroup.style.display = '';
    // Re-init action fields to use folder selects
    document.querySelectorAll('.action-type-select').forEach(s => toggleActionFields(s));
  }).catch(err => {
    console.error('Error loading folders:', err);
    alert('Failed to load folders: ' + err);
    folderSelect.innerHTML = '<option value="INBOX">INBOX (error)</option>';
    folderGroup.style.display = '';
  });
});

// Trigger initial load if account already selected
if (document.getElementById('email_account_id').value) {
  document.getElementById('email_account_id').dispatchEvent(new Event('change'));
}

function testRule() {
  const credentialId = document.getElementById('email_account_id').value;
  if (!credentialId) {
    alert('Please select an email account first.');
    return;
  }

  const logic = document.querySelector('input[name="logic"]:checked').value;

  const conditions = [];
  document.querySelectorAll('.condition-row').forEach((row, index) => {
    const field = row.querySelector(`select[name^="condition_field_"]`).value;
    const operator = row.querySelector(`select[name^="condition_operator_"]`).value;
    const valueEl = row.querySelector(`[name^="condition_value_"]`);
    const value = valueEl ? valueEl.value : '';
    conditions.push({ field, operator, value });
  });

  const actions = [];
  document.querySelectorAll('.action-row').forEach((row, index) => {
    const actionType = row.querySelector(`select[name^="action_type_"]`).value;
    const actionValueEl = row.querySelector(`[name^="action_value_"]`);
    const actionValue = actionValueEl ? actionValueEl.value : '';
    actions.push({ action_type: actionType, action_value: actionValue });
  });

  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('testLogModal'));
  modal.show();
  document.getElementById('log-output').innerHTML = '<div>Initializing test...</div>';
  document.getElementById('modal-status').textContent = 'Testing...';
  document.getElementById('modal-progress').textContent = '0 emails checked';

  const startTime = Date.now();
  const timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('modal-timer').textContent = `(${elapsed}s)`;
  }, 1000);

  let sessionId = null;
  let logIndex = 0;
  let logPollInterval = null;

  function pollLogs() {
    if (!sessionId) return;

    fetch(`/rules/test-logs/${sessionId}?after=${logIndex}`)
      .then(r => r.json())
      .then(data => {
        if (data.logs && data.logs.length > 0) {
          const logOutput = document.getElementById('log-output');
          data.logs.forEach(log => {
            const levelClass = log.level === 'SUCCESS' ? 'text-success' :
                              log.level === 'ERROR' ? 'text-danger' : '';
            logOutput.innerHTML += `<div class="${levelClass}">[${log.timestamp.split('T')[1].split('.')[0]}] ${log.message}</div>`;
          });
          logIndex = data.total_logs;
          logOutput.scrollTop = logOutput.scrollHeight;

          document.getElementById('modal-progress').textContent =
            data.logs[data.logs.length - 1].message.includes('Checking email') ?
            data.logs[data.logs.length - 1].message : document.getElementById('modal-progress').textContent;
        }

        if (data.status === 'completed' && logPollInterval) {
          clearInterval(logPollInterval);
        }
      });
  }

  fetch('/rules/test-preview', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      credential_id: parseInt(credentialId),
      logic: logic,
      conditions: conditions,
      actions: actions,
      max_emails: 10
    })
  })
  .then(response => response.json())
  .then(data => {
    clearInterval(timerInterval);
    if (logPollInterval) clearInterval(logPollInterval);

    sessionId = data.session_id;
    if (sessionId) {
      logPollInterval = setInterval(pollLogs, 500);
    }

    if (data.error) {
      document.getElementById('modal-status').textContent = 'Error!';
      document.getElementById('log-output').innerHTML += '<div class="text-danger">Error: ' + data.error + '</div>';
      return;
    }

    document.getElementById('modal-status').textContent = 'Complete!';
    document.getElementById('test-results-card').style.display = 'block';

    const results = data.results;
    const emailsChecked = data.emails_checked || 'N/A';
    const totalEmails = data.total_emails || 'N/A';
    const inboxTotal = data.inbox_total || 'N/A';

    let html = `
      <div class="alert alert-info">
        <strong>Matching Emails:</strong> ${results.length} / 10 max<br>
        <strong>Emails Checked:</strong> ${emailsChecked} / ${totalEmails} (Inbox total: ${inboxTotal})
      </div>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Subject</th>
            <th>From</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
    `;

    if (results.length === 0) {
      html += `
        <tr>
          <td colspan="4" class="text-center">No matching emails found.</td>
        </tr>
      `;
    }

    results.forEach((result, index) => {
      html += `
        <tr>
          <td>${result.email_subject.substring(0, 50)}${result.email_subject.length > 50 ? '...' : ''}</td>
          <td>${result.email_from}</td>
          <td>${result.email_date}</td>
          <td>
            <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse"
                    data-bs-target="#details-${index}">
              <i class="bi bi-eye"></i> View
            </button>
          </td>
        </tr>
        <tr class="collapse" id="details-${index}">
          <td colspan="4">
            <div class="card card-body">
              <h6>Condition Results:</h6>
      `;

      result.condition_results.forEach(cond => {
        html += `
          <div class="mb-2">
            <strong>${cond.field}</strong> ${cond.operator} "${cond.value}":
            ${cond.matched ?
              '<span class="badge bg-success">Matched</span>' :
              '<span class="badge bg-secondary">Not Matched</span>'}
            <br>
            <small class="text-muted">${cond.reason}</small>
          </div>
        `;
      });

      if (result.matched && result.actions_would_apply.length > 0) {
        html += `
          <h6 class="mt-3">Actions that would be applied:</h6>
          <ul>
        `;
        result.actions_would_apply.forEach(action => {
          html += `<li>${action}</li>`;
        });
        html += `</ul>`;
      }

      html += `
            </div>
          </td>
        </tr>
      `;
    });

    html += `
        </tbody>
      </table>
    `;

    document.getElementById('test-results-content').innerHTML = html;
  })
  .catch(error => {
    clearInterval(timerInterval);
    if (logPollInterval) clearInterval(logPollInterval);
    document.getElementById('modal-status').textContent = 'Error!';
    document.getElementById('log-output').innerHTML += '<div class="text-danger">Error: ' + error.message + '</div>';
  });
}
</script>
{% endblock %}
