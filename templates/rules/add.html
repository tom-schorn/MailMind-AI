{% extends "base.html" %}

{% block title %}Add Email Rule - MailMind AI{% endblock %}

{% block page_title %}Add Email Rule{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('list_rules') }}">Email Rules</a></li>
<li class="breadcrumb-item active">Add</li>
{% endblock %}

{% block content %}
<section class="section">
  <div class="row">
    <div class="col-lg-10">

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">New Email Rule</h5>

          <form class="row g-3" method="POST" action="{{ url_for('add_rule') }}">
            <!-- Basic Fields -->
            <div class="col-md-12">
              <label for="email_account_id" class="form-label">Email Account</label>
              <select class="form-select" id="email_account_id" name="email_account_id" required>
                <option value="">Select an email account...</option>
                {% for account in accounts %}
                <option value="{{ account.id }}">{{ account.email_address }} ({{ account.host }})</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-12">
              <label for="monitored_folder" class="form-label">Monitored Folder</label>
              <select class="form-select" id="monitored_folder" name="monitored_folder" required>
                <option value="INBOX" selected>INBOX (loading...)</option>
              </select>
              <div class="form-text">Select which folder to monitor for new emails</div>
            </div>

            <div class="col-md-8">
              <label for="name" class="form-label">Rule Name</label>
              <input type="text" class="form-control" id="name" name="name" required>
            </div>

            <div class="col-md-4">
              <label class="form-label">Enabled</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="enabled" name="enabled" checked>
                <label class="form-check-label" for="enabled">
                  Rule is active
                </label>
              </div>
            </div>

            <div class="col-md-12">
              <label class="form-label">Condition Logic</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="logic" id="logic_and" value="AND" checked>
                <label class="form-check-label" for="logic_and">
                  AND (all conditions must match)
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="logic" id="logic_or" value="OR">
                <label class="form-check-label" for="logic_or">
                  OR (at least one condition must match)
                </label>
              </div>
            </div>

            <!-- Conditions Section -->
            <div class="col-md-12">
              <hr>
              <h6>Conditions</h6>
              <div id="conditions-container">
                <div class="condition-row mb-2">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <select name="condition_field_0" class="form-select" required>
                        <option value="from">From</option>
                        <option value="subject">Subject</option>
                        <option value="body">Body</option>
                        <option value="to">To</option>
                        <option value="header">Header</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <select name="condition_operator_0" class="form-select" required>
                        <option value="contains">contains</option>
                        <option value="equals">equals</option>
                        <option value="not_equals">not equals</option>
                        <option value="starts_with">starts with</option>
                        <option value="ends_with">ends with</option>
                        <option value="greater_than">greater than</option>
                        <option value="less_than">less than</option>
                        <option value="greater_equal">greater or equal</option>
                        <option value="less_equal">less or equal</option>
                        <option value="date_older_than">date older than (days)</option>
                      </select>
                    </div>
                    <div class="col-md-5">
                      <input type="text" name="condition_value_0" class="form-control" placeholder="Value" required>
                    </div>
                    <div class="col-md-1">
                      <button type="button" class="btn btn-danger btn-sm" onclick="removeCondition(this)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-secondary" onclick="addCondition()">
                <i class="bi bi-plus-circle"></i> Add Condition
              </button>
            </div>

            <!-- Actions Section -->
            <div class="col-md-12">
              <hr>
              <h6>Actions</h6>
              <div id="actions-container">
                <div class="action-row mb-2">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <select name="action_type_0" class="form-select action-type-select" required onchange="toggleActionFields(this)">
                        <option value="move_to_folder">Move to Folder</option>
                        <option value="copy_to_folder">Copy to Folder</option>
                        <option value="add_label">Add Label</option>
                        <option value="mark_as_read">Mark as Read</option>
                        <option value="delete">Delete</option>
                        <option value="modify_subject">Modify Subject</option>
                      </select>
                    </div>
                    <div class="col-md-8">
                      <input type="text" name="action_value_0" class="form-control action-value" placeholder="Folder/Label/Subject Pattern" required>
                    </div>
                    <div class="col-md-1">
                      <button type="button" class="btn btn-danger btn-sm" onclick="removeAction(this)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-secondary" onclick="addAction()">
                <i class="bi bi-plus-circle"></i> Add Action
              </button>
            </div>

            <div class="text-center">
              <button type="button" class="btn btn-info" onclick="testRule()">
                <i class="bi bi-play-circle"></i> Test Rule (Dry-Run)
              </button>
              <button type="submit" class="btn btn-primary">Save Rule</button>
              <a href="{{ url_for('list_rules') }}" class="btn btn-secondary">Cancel</a>
            </div>
          </form>

        </div>
      </div>

      <!-- Test Log Modal -->
      <div class="modal fade" id="testLogModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Test Progress</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2">
                <strong>Status:</strong> <span id="modal-status">Testing...</span>
                <span id="modal-timer" class="text-muted ms-2">(0s)</span>
              </div>
              <div class="mb-2">
                <strong>Progress:</strong> <span id="modal-progress">0 emails checked</span>
              </div>
              <div style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                <div id="log-output"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Test Results Section -->
      <div class="card mt-3" id="test-results-card" style="display: none;">
        <div class="card-body">
          <h5 class="card-title">Test Results</h5>
          <div id="test-status" class="alert alert-info" style="display: none;">
            <i class="bi bi-hourglass-split"></i> <span id="test-progress">Testing...</span>
          </div>
          <div id="test-error" class="alert alert-danger" style="display: none;"></div>
          <div id="test-results-content"></div>
        </div>
      </div>

    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
let conditionIndex = 1;
let actionIndex = 1;

function addCondition() {
  const html = `
    <div class="condition-row mb-2">
      <div class="row g-2">
        <div class="col-md-3">
          <select name="condition_field_${conditionIndex}" class="form-select" required>
            <option value="from">From</option>
            <option value="subject">Subject</option>
            <option value="body">Body</option>
            <option value="to">To</option>
            <option value="header">Header</option>
          </select>
        </div>
        <div class="col-md-3">
          <select name="condition_operator_${conditionIndex}" class="form-select" required>
            <option value="contains">contains</option>
            <option value="equals">equals</option>
            <option value="not_equals">not equals</option>
            <option value="starts_with">starts with</option>
            <option value="ends_with">ends with</option>
            <option value="greater_than">greater than</option>
            <option value="less_than">less than</option>
            <option value="greater_equal">greater or equal</option>
            <option value="less_equal">less or equal</option>
            <option value="date_older_than">date older than (days)</option>
          </select>
        </div>
        <div class="col-md-5">
          <input type="text" name="condition_value_${conditionIndex}" class="form-control" placeholder="Value" required>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-danger btn-sm" onclick="removeCondition(this)">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('conditions-container').insertAdjacentHTML('beforeend', html);
  conditionIndex++;
}

function removeCondition(button) {
  const container = document.getElementById('conditions-container');
  if (container.children.length > 1) {
    button.closest('.condition-row').remove();
  } else {
    alert('At least one condition is required.');
  }
}

function addAction() {
  const html = `
    <div class="action-row mb-2">
      <div class="row g-2">
        <div class="col-md-3">
          <select name="action_type_${actionIndex}" class="form-select action-type-select" required onchange="toggleActionFields(this)">
            <option value="move_to_folder">Move to Folder</option>
            <option value="copy_to_folder">Copy to Folder</option>
            <option value="add_label">Add Label</option>
            <option value="mark_as_read">Mark as Read</option>
            <option value="delete">Delete</option>
            <option value="modify_subject">Modify Subject</option>
          </select>
        </div>
        <div class="col-md-8">
          <input type="text" name="action_value_${actionIndex}" class="form-control action-value" placeholder="Folder/Label/Subject Pattern" required>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-danger btn-sm" onclick="removeAction(this)">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('actions-container').insertAdjacentHTML('beforeend', html);
  actionIndex++;
}

function removeAction(button) {
  const container = document.getElementById('actions-container');
  if (container.children.length > 1) {
    button.closest('.action-row').remove();
  } else {
    alert('At least one action is required.');
  }
}

function toggleActionFields(select) {
  const row = select.closest('.action-row');
  const valueInput = row.querySelector('.action-value');
  const actionType = select.value;

  if (actionType === 'mark_as_read' || actionType === 'delete') {
    valueInput.style.display = 'none';
    valueInput.removeAttribute('required');
    valueInput.value = '';
  } else {
    valueInput.style.display = 'block';
    valueInput.setAttribute('required', 'required');

    // Update placeholder
    if (actionType === 'move_to_folder' || actionType === 'copy_to_folder') {
      valueInput.placeholder = 'Folder path (e.g., INBOX/Spam)';
    } else if (actionType === 'add_label') {
      valueInput.placeholder = 'Label name';
    } else if (actionType === 'modify_subject') {
      valueInput.placeholder = 'New subject pattern';
    }
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.action-type-select').forEach(select => {
    toggleActionFields(select);
  });
});

// Load folders when account is selected
document.getElementById('email_account_id').addEventListener('change', function() {
  const credentialId = this.value;
  const folderSelect = document.getElementById('monitored_folder');

  if (!credentialId) {
    folderSelect.innerHTML = '<option value="INBOX">INBOX (default)</option>';
    return;
  }

  folderSelect.innerHTML = '<option value="INBOX">INBOX (loading...)</option>';

  fetch(`/api/folders/${credentialId}`)
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        console.error('Error loading folders:', data.error);
        alert('Failed to load folders: ' + data.error);
        folderSelect.innerHTML = '<option value="INBOX">INBOX (error)</option>';
        return;
      }

      folderSelect.innerHTML = '';
      data.folders.forEach(folder => {
        if (folder.selectable) {
          const option = document.createElement('option');
          option.value = folder.name;
          option.textContent = folder.name;
          if (folder.name === 'INBOX') {
            option.selected = true;
          }
          folderSelect.appendChild(option);
        }
      });
    })
    .catch(err => {
      console.error('Error loading folders:', err);
      alert('Failed to load folders');
      folderSelect.innerHTML = '<option value="INBOX">INBOX (error)</option>';
    });
});

// Trigger initial load if account already selected
if (document.getElementById('email_account_id').value) {
  document.getElementById('email_account_id').dispatchEvent(new Event('change'));
}

function testRule() {
  const credentialId = document.getElementById('email_account_id').value;
  if (!credentialId) {
    alert('Please select an email account first.');
    return;
  }

  const logic = document.querySelector('input[name="logic"]:checked').value;

  const conditions = [];
  document.querySelectorAll('.condition-row').forEach((row, index) => {
    const field = row.querySelector(`select[name^="condition_field_"]`).value;
    const operator = row.querySelector(`select[name^="condition_operator_"]`).value;
    const value = row.querySelector(`input[name^="condition_value_"]`).value;
    conditions.push({ field, operator, value });
  });

  const actions = [];
  document.querySelectorAll('.action-row').forEach((row, index) => {
    const actionType = row.querySelector(`select[name^="action_type_"]`).value;
    const actionValue = row.querySelector(`input[name^="action_value_"]`).value || '';
    actions.push({ action_type: actionType, action_value: actionValue });
  });

  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('testLogModal'));
  modal.show();
  document.getElementById('log-output').innerHTML = '<div>Initializing test...</div>';
  document.getElementById('modal-status').textContent = 'Testing...';
  document.getElementById('modal-progress').textContent = '0 emails checked';

  const startTime = Date.now();
  const timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('modal-timer').textContent = `(${elapsed}s)`;
  }, 1000);

  let sessionId = null;
  let logIndex = 0;
  let logPollInterval = null;

  function pollLogs() {
    if (!sessionId) return;

    fetch(`/rules/test-logs/${sessionId}?after=${logIndex}`)
      .then(r => r.json())
      .then(data => {
        if (data.logs && data.logs.length > 0) {
          const logOutput = document.getElementById('log-output');
          data.logs.forEach(log => {
            const levelClass = log.level === 'SUCCESS' ? 'text-success' :
                              log.level === 'ERROR' ? 'text-danger' : '';
            logOutput.innerHTML += `<div class="${levelClass}">[${log.timestamp.split('T')[1].split('.')[0]}] ${log.message}</div>`;
          });
          logIndex = data.total_logs;
          logOutput.scrollTop = logOutput.scrollHeight;

          document.getElementById('modal-progress').textContent =
            data.logs[data.logs.length - 1].message.includes('Checking email') ?
            data.logs[data.logs.length - 1].message : document.getElementById('modal-progress').textContent;
        }

        if (data.status === 'completed' && logPollInterval) {
          clearInterval(logPollInterval);
        }
      });
  }

  fetch('/rules/test-preview', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      credential_id: parseInt(credentialId),
      logic: logic,
      conditions: conditions,
      actions: actions,
      max_emails: 10
    })
  })
  .then(response => response.json())
  .then(data => {
    clearInterval(timerInterval);
    if (logPollInterval) clearInterval(logPollInterval);

    sessionId = data.session_id;
    if (sessionId) {
      logPollInterval = setInterval(pollLogs, 500);
    }

    if (data.error) {
      document.getElementById('modal-status').textContent = 'Error!';
      document.getElementById('log-output').innerHTML += '<div class="text-danger">Error: ' + data.error + '</div>';
      return;
    }

    document.getElementById('modal-status').textContent = 'Complete!';
    document.getElementById('test-results-card').style.display = 'block';

    const results = data.results;
    const emailsChecked = data.emails_checked || 'N/A';
    const totalEmails = data.total_emails || 'N/A';
    const inboxTotal = data.inbox_total || 'N/A';

    let html = `
      <div class="alert alert-info">
        <strong>Matching Emails:</strong> ${results.length} / 10 max<br>
        <strong>Emails Checked:</strong> ${emailsChecked} / ${totalEmails} (Inbox total: ${inboxTotal})
      </div>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Subject</th>
            <th>From</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
    `;

    if (results.length === 0) {
      html += `
        <tr>
          <td colspan="4" class="text-center">No matching emails found.</td>
        </tr>
      `;
    }

    results.forEach((result, index) => {
      html += `
        <tr>
          <td>${result.email_subject.substring(0, 50)}${result.email_subject.length > 50 ? '...' : ''}</td>
          <td>${result.email_from}</td>
          <td>${result.email_date}</td>
          <td>
            <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse"
                    data-bs-target="#details-${index}">
              <i class="bi bi-eye"></i> View
            </button>
          </td>
        </tr>
        <tr class="collapse" id="details-${index}">
          <td colspan="4">
            <div class="card card-body">
              <h6>Condition Results:</h6>
      `;

      result.condition_results.forEach(cond => {
        html += `
          <div class="mb-2">
            <strong>${cond.field}</strong> ${cond.operator} "${cond.value}":
            ${cond.matched ?
              '<span class="badge bg-success">Matched</span>' :
              '<span class="badge bg-secondary">Not Matched</span>'}
            <br>
            <small class="text-muted">${cond.reason}</small>
          </div>
        `;
      });

      if (result.matched && result.actions_would_apply.length > 0) {
        html += `
          <h6 class="mt-3">Actions that would be applied:</h6>
          <ul>
        `;
        result.actions_would_apply.forEach(action => {
          html += `<li>${action}</li>`;
        });
        html += `</ul>`;
      }

      html += `
            </div>
          </td>
        </tr>
      `;
    });

    html += `
        </tbody>
      </table>
    `;

    document.getElementById('test-results-content').innerHTML = html;
  })
  .catch(error => {
    clearInterval(timerInterval);
    if (logPollInterval) clearInterval(logPollInterval);
    document.getElementById('modal-status').textContent = 'Error!';
    document.getElementById('log-output').innerHTML += '<div class="text-danger">Error: ' + error.message + '</div>';
  });
}
</script>
{% endblock %}
