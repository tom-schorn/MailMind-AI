{% extends "base.html" %}

{% block title %}Edit Email Rule - MailMind AI{% endblock %}

{% block page_title %}Edit Email Rule{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('list_accounts') }}">Email Accounts</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('account_dashboard', id=account.id) }}">{{ account.email_address }}</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('account_rules', id=account.id) }}">Rules</a></li>
<li class="breadcrumb-item active">Edit</li>
{% endblock %}

{% block content %}
<section class="section">
  <div class="row">
    <div class="col-lg-10">

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Edit Email Rule</h5>

          <form class="row g-3" method="POST" action="{{ url_for('account_edit_rule', id=account.id, rule_id=rule.id) }}">
            <input type="hidden" name="email_account_id" id="email_account_id" value="{{ account.id }}">

            <div class="col-md-12">
              <label for="monitored_folder" class="form-label">Monitored Folder</label>
              <select class="form-select" id="monitored_folder" name="monitored_folder" required>
                <option value="{{ rule.monitored_folder if rule.monitored_folder else 'INBOX' }}" selected>
                  {{ rule.monitored_folder if rule.monitored_folder else 'INBOX' }}
                </option>
              </select>
              <div class="form-text">Select which folder to monitor for new emails</div>
            </div>

            <div class="col-md-8">
              <label for="name" class="form-label">Rule Name</label>
              <input type="text" class="form-control" id="name" name="name" value="{{ rule.name }}" required>
            </div>

            <div class="col-md-4">
              <label class="form-label">Enabled</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="enabled" name="enabled" {% if rule.enabled %}checked{% endif %}>
                <label class="form-check-label" for="enabled">
                  Rule is active
                </label>
              </div>
            </div>

            <div class="col-md-12">
              <label class="form-label">Condition Logic</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="logic" id="logic_and" value="AND" {% if rule.condition == 'AND' %}checked{% endif %}>
                <label class="form-check-label" for="logic_and">
                  AND (all conditions must match)
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="logic" id="logic_or" value="OR" {% if rule.condition == 'OR' %}checked{% endif %}>
                <label class="form-check-label" for="logic_or">
                  OR (at least one condition must match)
                </label>
              </div>
            </div>

            <!-- Conditions Section -->
            <div class="col-md-12">
              <hr>
              <h6>Conditions</h6>
              <div id="conditions-container">
                {% for cond in rule.conditions %}
                <div class="condition-row mb-2">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <select name="condition_field_{{ loop.index0 }}" class="form-select condition-field-select" required onchange="onConditionFieldChange(this)">
                        <option value="from" {% if cond.field == 'from' %}selected{% endif %}>From</option>
                        <option value="subject" {% if cond.field == 'subject' %}selected{% endif %}>Subject</option>
                        <option value="body" {% if cond.field == 'body' %}selected{% endif %}>Body</option>
                        <option value="to" {% if cond.field == 'to' %}selected{% endif %}>To</option>
                        <option value="header" {% if cond.field == 'header' %}selected{% endif %}>Header</option>
                        <option value="date" {% if cond.field == 'date' %}selected{% endif %}>Date</option>
                        <option value="label" {% if cond.field == 'label' %}selected{% endif %}>Label</option>
                        <optgroup label="Attachment">
                          <option value="has_attachment" {% if cond.field == 'has_attachment' %}selected{% endif %}>Has Attachment</option>
                          <option value="attachment_count" {% if cond.field == 'attachment_count' %}selected{% endif %}>Attachment Count</option>
                          <option value="attachment_format" {% if cond.field == 'attachment_format' %}selected{% endif %}>Attachment Format</option>
                          <option value="attachment_filename" {% if cond.field == 'attachment_filename' %}selected{% endif %}>Attachment Filename</option>
                          <option value="attachment_size" {% if cond.field == 'attachment_size' %}selected{% endif %}>Attachment Size</option>
                        </optgroup>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <select name="condition_operator_{{ loop.index0 }}" class="form-select condition-operator-select" required>
                        <option value="contains" {% if cond.operator == 'contains' %}selected{% endif %}>contains</option>
                        <option value="equals" {% if cond.operator == 'equals' %}selected{% endif %}>equals</option>
                        <option value="not_equals" {% if cond.operator == 'not_equals' %}selected{% endif %}>not equals</option>
                        <option value="starts_with" {% if cond.operator == 'starts_with' %}selected{% endif %}>starts with</option>
                        <option value="ends_with" {% if cond.operator == 'ends_with' %}selected{% endif %}>ends with</option>
                        <option value="greater_than" {% if cond.operator == 'greater_than' %}selected{% endif %}>greater than</option>
                        <option value="less_than" {% if cond.operator == 'less_than' %}selected{% endif %}>less than</option>
                        <option value="greater_equal" {% if cond.operator == 'greater_equal' %}selected{% endif %}>greater or equal</option>
                        <option value="less_equal" {% if cond.operator == 'less_equal' %}selected{% endif %}>less or equal</option>
                        <option value="date_older_than" {% if cond.operator == 'date_older_than' %}selected{% endif %}>older than (days)</option>
                        <option value="date_before" {% if cond.operator == 'date_before' %}selected{% endif %}>before (date)</option>
                        <option value="has_label" {% if cond.operator == 'has_label' %}selected{% endif %}>has label</option>
                        <option value="not_has_label" {% if cond.operator == 'not_has_label' %}selected{% endif %}>does not have label</option>
                      </select>
                    </div>
                    <div class="col-md-5">
                      <input type="text" name="condition_value_{{ loop.index0 }}" class="form-control condition-value-input" placeholder="Value" value="{{ cond.value }}" required>
                    </div>
                    <div class="col-md-1">
                      <button type="button" class="btn btn-danger btn-sm" onclick="removeCondition(this)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              <button type="button" class="btn btn-sm btn-secondary" onclick="addCondition()">
                <i class="bi bi-plus-circle"></i> Add Condition
              </button>
            </div>

            <!-- Actions Section -->
            <div class="col-md-12">
              <hr>
              <h6>Actions</h6>
              <div id="actions-container">
                {% for action in rule.rule_actions %}
                <div class="action-row mb-2">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <select name="action_type_{{ loop.index0 }}" class="form-select action-type-select" required onchange="toggleActionFields(this)">
                        <option value="move_to_folder" {% if action.action_type == 'move_to_folder' %}selected{% endif %}>Move to Folder</option>
                        <option value="copy_to_folder" {% if action.action_type == 'copy_to_folder' %}selected{% endif %}>Copy to Folder</option>
                        <option value="add_label" {% if action.action_type == 'add_label' %}selected{% endif %}>Add Label</option>
                        <option value="mark_as_read" {% if action.action_type == 'mark_as_read' %}selected{% endif %}>Mark as Read</option>
                        <option value="delete" {% if action.action_type == 'delete' %}selected{% endif %}>Delete</option>
                        <option value="modify_subject" {% if action.action_type == 'modify_subject' %}selected{% endif %}>Modify Subject</option>
                        <option value="save_attachments" {% if action.action_type == 'save_attachments' %}selected{% endif %}>Save Attachments</option>
                      </select>
                    </div>
                    <div class="col-md-8">
                      <input type="text" name="action_value_{{ loop.index0 }}" class="form-control action-value" placeholder="Folder/Label/Subject Pattern" value="{{ action.action_value }}">
                    </div>
                    <div class="col-md-1">
                      <button type="button" class="btn btn-danger btn-sm" onclick="removeAction(this)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              <button type="button" class="btn btn-sm btn-secondary" onclick="addAction()">
                <i class="bi bi-plus-circle"></i> Add Action
              </button>
            </div>

            <div class="text-center">
              <button type="button" class="btn btn-info" onclick="testRule()">
                <i class="bi bi-play-circle"></i> Test Rule (Dry-Run)
              </button>
              <button type="submit" class="btn btn-primary">Update Rule</button>
              <a href="{{ url_for('account_rules', id=account.id) }}" class="btn btn-secondary">Cancel</a>
            </div>
          </form>

        </div>
      </div>

      <!-- Test Results Section -->
      <div class="card mt-3" id="test-results-card" style="display: none;">
        <div class="card-body">
          <h5 class="card-title">Test Results</h5>
          <div id="test-status" class="alert alert-info" style="display: none;">
            <i class="bi bi-hourglass-split"></i> Testing...
          </div>
          <div id="test-error" class="alert alert-danger" style="display: none;"></div>
          <div id="test-results-content"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Create Label Modal -->
  <div class="modal fade" id="createLabelModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Label</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="new-label-name" class="form-label">Label Name</label>
            <input type="text" class="form-control" id="new-label-name" required>
          </div>
          <div class="mb-3">
            <label for="new-label-color" class="form-label">Color</label>
            <input type="color" class="form-control form-control-color" id="new-label-color" value="#0d6efd">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveNewLabel()">Create</button>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
const credentialId = {{ account.id }};
let conditionIndex = {{ rule.conditions|length }};
let actionIndex = {{ rule.rule_actions|length }};
let cachedFolders = null;
let cachedLabels = null;
let labelTargetElement = null;

function fetchFoldersIfNeeded() {
  if (cachedFolders) return Promise.resolve(cachedFolders);
  return fetch(`/api/folders/${credentialId}`)
    .then(r => r.json())
    .then(data => {
      if (data.error) throw data.error;
      cachedFolders = data.folders;
      return data.folders;
    });
}

function fetchLabelsIfNeeded() {
  if (cachedLabels) return Promise.resolve(cachedLabels);
  return fetch(`/api/labels/${credentialId}`)
    .then(r => r.json())
    .then(data => {
      if (data.error) throw data.error;
      cachedLabels = data.labels;
      return data.labels;
    });
}

function buildLabelSelect(inputName, currentValue, onChange) {
  const sel = document.createElement('select');
  sel.name = inputName;
  sel.className = 'form-select condition-value-input';
  sel.required = true;
  if (onChange) sel.addEventListener('change', onChange);

  fetchLabelsIfNeeded().then(labels => {
    sel.innerHTML = '';
    labels.forEach(label => {
      const opt = document.createElement('option');
      opt.value = label.name;
      opt.textContent = label.name;
      if (label.name === currentValue) opt.selected = true;
      sel.appendChild(opt);
    });
    const createOpt = document.createElement('option');
    createOpt.value = '__create_new__';
    createOpt.textContent = '+ Create New Label...';
    sel.appendChild(createOpt);
  });

  return sel;
}

function buildLabelSelectForAction(inputName, currentValue) {
  const sel = document.createElement('select');
  sel.name = inputName;
  sel.className = 'form-select action-value';
  sel.required = true;

  fetchLabelsIfNeeded().then(labels => {
    sel.innerHTML = '';
    labels.forEach(label => {
      const opt = document.createElement('option');
      opt.value = label.name;
      opt.textContent = label.name;
      if (label.name === currentValue) opt.selected = true;
      sel.appendChild(opt);
    });
    const createOpt = document.createElement('option');
    createOpt.value = '__create_new__';
    createOpt.textContent = '+ Create New Label...';
    sel.appendChild(createOpt);
  });

  sel.addEventListener('change', function() {
    if (this.value === '__create_new__') {
      labelTargetElement = this;
      new bootstrap.Modal(document.getElementById('createLabelModal')).show();
    }
  });

  return sel;
}

function saveNewLabel() {
  const name = document.getElementById('new-label-name').value.trim();
  const color = document.getElementById('new-label-color').value;

  if (!name) { alert('Please enter a label name.'); return; }

  fetch(`/api/labels/${credentialId}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({name: name, color: color})
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) { alert('Error: ' + data.error); return; }

    cachedLabels = null;
    bootstrap.Modal.getInstance(document.getElementById('createLabelModal')).hide();
    document.getElementById('new-label-name').value = '';

    if (labelTargetElement) {
      const targetSelect = labelTargetElement;
      fetchLabelsIfNeeded().then(labels => {
        targetSelect.innerHTML = '';
        labels.forEach(label => {
          const opt = document.createElement('option');
          opt.value = label.name;
          opt.textContent = label.name;
          if (label.name === name) opt.selected = true;
          targetSelect.appendChild(opt);
        });
        const createOpt = document.createElement('option');
        createOpt.value = '__create_new__';
        createOpt.textContent = '+ Create New Label...';
        targetSelect.appendChild(createOpt);
      });
      labelTargetElement = null;
    }
  })
  .catch(err => alert('Error creating label: ' + err));
}

const standardOperators = [
  {value: 'contains', text: 'contains'},
  {value: 'equals', text: 'equals'},
  {value: 'not_equals', text: 'not equals'},
  {value: 'starts_with', text: 'starts with'},
  {value: 'ends_with', text: 'ends with'},
  {value: 'greater_than', text: 'greater than'},
  {value: 'less_than', text: 'less than'},
  {value: 'greater_equal', text: 'greater or equal'},
  {value: 'less_equal', text: 'less or equal'},
  {value: 'date_older_than', text: 'older than (days)'},
  {value: 'date_before', text: 'before (date)'}
];

const dateOperators = [
  {value: 'date_older_than', text: 'older than (days)'},
  {value: 'date_before', text: 'before (date)'}
];

const labelOperators = [
  {value: 'has_label', text: 'has label'},
  {value: 'not_has_label', text: 'does not have label'}
];

const hasAttachmentOperators = [
  {value: 'equals', text: 'equals'}
];

const attachmentCountOperators = [
  {value: 'equals', text: 'equals'},
  {value: 'greater_than', text: 'greater than'},
  {value: 'less_than', text: 'less than'}
];

const attachmentFormatOperators = [
  {value: 'contains', text: 'contains'}
];

const attachmentFilenameOperators = [
  {value: 'contains', text: 'contains'},
  {value: 'equals', text: 'equals'},
  {value: 'starts_with', text: 'starts with'},
  {value: 'ends_with', text: 'ends with'}
];

const attachmentSizeOperators = [
  {value: 'greater_than', text: 'greater than'},
  {value: 'less_than', text: 'less than'}
];

const mimeTypes = [
  {value: 'application/pdf', text: 'PDF'},
  {value: 'image/jpeg', text: 'JPEG'},
  {value: 'image/png', text: 'PNG'},
  {value: 'application/zip', text: 'ZIP'},
  {value: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', text: 'DOCX'},
  {value: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', text: 'XLSX'},
  {value: 'text/plain', text: 'TXT'},
  {value: 'text/csv', text: 'CSV'}
];

function getOperatorsForField(field) {
  switch (field) {
    case 'date': return dateOperators;
    case 'label': return labelOperators;
    case 'has_attachment': return hasAttachmentOperators;
    case 'attachment_count': return attachmentCountOperators;
    case 'attachment_format': return attachmentFormatOperators;
    case 'attachment_filename': return attachmentFilenameOperators;
    case 'attachment_size': return attachmentSizeOperators;
    default: return standardOperators;
  }
}

function onConditionFieldChange(fieldSelect) {
  const row = fieldSelect.closest('.condition-row');
  const operatorSelect = row.querySelector('.condition-operator-select');
  const field = fieldSelect.value;
  const currentOp = operatorSelect.value;

  const operators = getOperatorsForField(field);

  operatorSelect.innerHTML = '';
  operators.forEach(op => {
    const option = document.createElement('option');
    option.value = op.value;
    option.textContent = op.text;
    if (op.value === currentOp) option.selected = true;
    operatorSelect.appendChild(option);
  });

  updateConditionValueInput(row);
}

function updateConditionValueInput(row) {
  const operatorSelect = row.querySelector('.condition-operator-select');
  const valueContainer = row.querySelector('.col-md-5');
  const operator = operatorSelect.value;
  const existingInput = valueContainer.querySelector('[name^="condition_value_"]');
  const inputName = existingInput ? existingInput.name : valueContainer.querySelector('[data-name]') ? valueContainer.querySelector('[data-name]').getAttribute('data-name') : 'condition_value_0';
  const currentValue = existingInput ? existingInput.value : '';
  const fieldSelect = row.querySelector('.condition-field-select');
  const field = fieldSelect ? fieldSelect.value : '';
  const target = existingInput || valueContainer.querySelector('.input-group');

  if (field === 'has_attachment') {
    const sel = document.createElement('select');
    sel.name = inputName;
    sel.className = 'form-select condition-value-input';
    sel.required = true;
    sel.innerHTML = '<option value="yes"' + (currentValue === 'yes' ? ' selected' : '') + '>Yes</option><option value="no"' + (currentValue === 'no' ? ' selected' : '') + '>No</option>';
    target.replaceWith(sel);
  } else if (field === 'attachment_count') {
    if (!existingInput || existingInput.type !== 'number') {
      const numInput = document.createElement('input');
      numInput.type = 'number';
      numInput.name = inputName;
      numInput.className = 'form-control condition-value-input';
      numInput.placeholder = 'Count (e.g. 3)';
      numInput.min = '0';
      numInput.required = true;
      numInput.value = currentValue;
      target.replaceWith(numInput);
    }
  } else if (field === 'attachment_format') {
    const sel = document.createElement('select');
    sel.name = inputName;
    sel.className = 'form-select condition-value-input';
    sel.required = true;
    mimeTypes.forEach(mt => {
      const opt = document.createElement('option');
      opt.value = mt.value;
      opt.textContent = `${mt.text} (${mt.value})`;
      if (mt.value === currentValue) opt.selected = true;
      sel.appendChild(opt);
    });
    target.replaceWith(sel);
  } else if (field === 'attachment_filename') {
    if (!existingInput || existingInput.tagName !== 'INPUT' || existingInput.type !== 'text') {
      const textInput = document.createElement('input');
      textInput.type = 'text';
      textInput.name = inputName;
      textInput.className = 'form-control condition-value-input';
      textInput.placeholder = 'Filename pattern (e.g. invoice)';
      textInput.required = true;
      textInput.value = currentValue;
      target.replaceWith(textInput);
    } else {
      existingInput.placeholder = 'Filename pattern (e.g. invoice)';
    }
  } else if (field === 'attachment_size') {
    const wrapper = document.createElement('div');
    wrapper.className = 'input-group condition-value-input';
    wrapper.setAttribute('data-name', inputName);

    // Parse existing value like "5 MB"
    let numVal = '';
    let unitVal = 'MB';
    if (currentValue) {
      const parts = currentValue.trim().split(/\s+/);
      if (parts.length >= 2) { numVal = parts[0]; unitVal = parts[1]; }
      else { numVal = parts[0]; }
    }

    const numInput = document.createElement('input');
    numInput.type = 'number';
    numInput.className = 'form-control';
    numInput.placeholder = 'Size';
    numInput.min = '0';
    numInput.step = 'any';
    numInput.value = numVal;
    numInput.id = inputName + '_num';

    const unitSel = document.createElement('select');
    unitSel.className = 'form-select';
    unitSel.style.maxWidth = '80px';
    unitSel.id = inputName + '_unit';
    ['KB', 'MB', 'GB'].forEach(u => {
      const opt = document.createElement('option');
      opt.value = u; opt.textContent = u;
      if (u === unitVal) opt.selected = true;
      unitSel.appendChild(opt);
    });

    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = inputName;
    hiddenInput.className = 'condition-value-input';
    hiddenInput.required = true;

    function updateHidden() {
      const num = numInput.value || '0';
      hiddenInput.value = num + ' ' + unitSel.value;
    }
    numInput.addEventListener('input', updateHidden);
    unitSel.addEventListener('change', updateHidden);

    wrapper.appendChild(numInput);
    wrapper.appendChild(unitSel);
    wrapper.appendChild(hiddenInput);
    updateHidden();

    target.replaceWith(wrapper);
  } else if (operator === 'date_before') {
    if (!existingInput || existingInput.type !== 'date') {
      const dateInput = document.createElement('input');
      dateInput.type = 'date';
      dateInput.name = inputName;
      dateInput.className = 'form-control condition-value-input';
      dateInput.required = true;
      dateInput.value = currentValue;
      target.replaceWith(dateInput);
    }
  } else if (field === 'label') {
    const sel = buildLabelSelect(inputName, currentValue, function() {
      if (this.value === '__create_new__') {
        labelTargetElement = this;
        new bootstrap.Modal(document.getElementById('createLabelModal')).show();
      }
    });
    if (sel) target.replaceWith(sel);
  } else {
    if (!existingInput || existingInput.type === 'date' || existingInput.tagName !== 'INPUT') {
      const textInput = document.createElement('input');
      textInput.type = 'text';
      textInput.name = inputName;
      textInput.className = 'form-control condition-value-input';
      textInput.placeholder = operator === 'date_older_than' ? 'Days (e.g. 30)' : 'Value';
      textInput.required = true;
      textInput.value = currentValue;
      target.replaceWith(textInput);
    } else {
      existingInput.placeholder = operator === 'date_older_than' ? 'Days (e.g. 30)' : 'Value';
    }
  }
}

function addCondition() {
  const html = `
    <div class="condition-row mb-2">
      <div class="row g-2">
        <div class="col-md-3">
          <select name="condition_field_${conditionIndex}" class="form-select condition-field-select" required onchange="onConditionFieldChange(this)">
            <option value="from">From</option>
            <option value="subject">Subject</option>
            <option value="body">Body</option>
            <option value="to">To</option>
            <option value="header">Header</option>
            <option value="date">Date</option>
            <option value="label">Label</option>
            <optgroup label="Attachment">
              <option value="has_attachment">Has Attachment</option>
              <option value="attachment_count">Attachment Count</option>
              <option value="attachment_format">Attachment Format</option>
              <option value="attachment_filename">Attachment Filename</option>
              <option value="attachment_size">Attachment Size</option>
            </optgroup>
          </select>
        </div>
        <div class="col-md-3">
          <select name="condition_operator_${conditionIndex}" class="form-select condition-operator-select" required>
            <option value="contains">contains</option>
            <option value="equals">equals</option>
            <option value="not_equals">not equals</option>
            <option value="starts_with">starts with</option>
            <option value="ends_with">ends with</option>
            <option value="greater_than">greater than</option>
            <option value="less_than">less than</option>
            <option value="greater_equal">greater or equal</option>
            <option value="less_equal">less or equal</option>
            <option value="date_older_than">older than (days)</option>
            <option value="date_before">before (date)</option>
          </select>
        </div>
        <div class="col-md-5">
          <input type="text" name="condition_value_${conditionIndex}" class="form-control condition-value-input" placeholder="Value" required>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-danger btn-sm" onclick="removeCondition(this)">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('conditions-container').insertAdjacentHTML('beforeend', html);
  conditionIndex++;
}

function removeCondition(button) {
  const container = document.getElementById('conditions-container');
  if (container.children.length > 1) {
    button.closest('.condition-row').remove();
  } else {
    alert('At least one condition is required.');
  }
}

function addAction() {
  const idx = actionIndex;
  const html = `
    <div class="action-row mb-2">
      <div class="row g-2">
        <div class="col-md-3">
          <select name="action_type_${idx}" class="form-select action-type-select" required onchange="toggleActionFields(this)">
            <option value="move_to_folder">Move to Folder</option>
            <option value="copy_to_folder">Copy to Folder</option>
            <option value="add_label">Add Label</option>
            <option value="mark_as_read">Mark as Read</option>
            <option value="delete">Delete</option>
            <option value="modify_subject">Modify Subject</option>
            <option value="save_attachments">Save Attachments</option>
          </select>
        </div>
        <div class="col-md-8">
          <input type="text" name="action_value_${idx}" class="form-control action-value" placeholder="Folder/Label/Subject Pattern" required>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-danger btn-sm" onclick="removeAction(this)">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('actions-container').insertAdjacentHTML('beforeend', html);
  actionIndex++;
  const newRow = document.getElementById('actions-container').lastElementChild;
  toggleActionFields(newRow.querySelector('.action-type-select'));
}

function removeAction(button) {
  const container = document.getElementById('actions-container');
  if (container.children.length > 1) {
    button.closest('.action-row').remove();
  } else {
    alert('At least one action is required.');
  }
}

function toggleActionFields(select) {
  const row = select.closest('.action-row');
  const valueContainer = row.querySelector('.col-md-8');
  const existingEl = valueContainer.querySelector('.action-value');
  const actionType = select.value;
  const elName = existingEl.name;
  const currentValue = existingEl.value;

  if (actionType === 'save_attachments') {
    const oldInfo = valueContainer.querySelector('.action-info');
    if (!oldInfo) {
      if (existingEl.tagName === 'SELECT') {
        const input = document.createElement('input');
        input.type = 'text';
        input.name = elName;
        input.className = 'form-control action-value';
        existingEl.replaceWith(input);
      }
      const el = valueContainer.querySelector('.action-value');
      el.style.display = 'none';
      el.removeAttribute('required');
      el.value = '';
      const info = document.createElement('small');
      info.className = 'text-muted action-info';
      info.textContent = 'Attachments will be saved to DATA_DIR/attachments/<account>/<rule>/';
      valueContainer.appendChild(info);
    }
  } else if (actionType === 'mark_as_read' || actionType === 'delete') {
    const oldInfo2 = valueContainer.querySelector('.action-info');
    if (oldInfo2) oldInfo2.remove();
    if (existingEl.tagName === 'SELECT') {
      const input = document.createElement('input');
      input.type = 'text';
      input.name = elName;
      input.className = 'form-control action-value';
      existingEl.replaceWith(input);
    }
    const el = valueContainer.querySelector('.action-value');
    el.style.display = 'none';
    el.removeAttribute('required');
    el.value = '';
  } else if (actionType === 'move_to_folder' || actionType === 'copy_to_folder') {
    const oldInfo3 = valueContainer.querySelector('.action-info');
    if (oldInfo3) oldInfo3.remove();
    fetchFoldersIfNeeded().then(folders => {
      const sel = document.createElement('select');
      sel.name = elName;
      sel.className = 'form-select action-value';
      sel.required = true;
      folders.forEach(folder => {
        if (folder.selectable) {
          const opt = document.createElement('option');
          opt.value = folder.name;
          opt.textContent = folder.name;
          if (folder.name === currentValue) opt.selected = true;
          sel.appendChild(opt);
        }
      });
      existingEl.replaceWith(sel);
    });
  } else if (actionType === 'add_label') {
    const oldInfo4 = valueContainer.querySelector('.action-info');
    if (oldInfo4) oldInfo4.remove();
    const labelSel = buildLabelSelectForAction(elName, currentValue);
    if (labelSel) {
      existingEl.replaceWith(labelSel);
      return;
    }
    if (existingEl.tagName === 'SELECT') {
      const input = document.createElement('input');
      input.type = 'text';
      input.name = elName;
      input.className = 'form-control action-value';
      input.placeholder = 'Label name';
      input.required = true;
      input.value = currentValue;
      existingEl.replaceWith(input);
    } else {
      existingEl.style.display = 'block';
      existingEl.setAttribute('required', 'required');
      existingEl.placeholder = 'Label name';
    }
  } else {
    if (existingEl.tagName === 'SELECT') {
      const input = document.createElement('input');
      input.type = 'text';
      input.name = elName;
      input.className = 'form-control action-value';
      input.required = true;
      input.value = currentValue;
      existingEl.replaceWith(input);
    }
    const el = valueContainer.querySelector('.action-value');
    el.style.display = 'block';
    el.setAttribute('required', 'required');
    if (actionType === 'modify_subject') {
      el.placeholder = 'New subject pattern';
    } else {
      el.placeholder = 'Value';
    }
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.action-type-select').forEach(select => {
    toggleActionFields(select);
  });
  document.querySelectorAll('.condition-field-select').forEach(select => {
    onConditionFieldChange(select);
  });
  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('condition-operator-select')) {
      updateConditionValueInput(e.target.closest('.condition-row'));
    }
  });
});

function testRule() {
  const logic = document.querySelector('input[name="logic"]:checked').value;

  const conditions = [];
  document.querySelectorAll('.condition-row').forEach(row => {
    const field = row.querySelector('select[name^="condition_field_"]').value;
    const operator = row.querySelector('select[name^="condition_operator_"]').value;
    const valueEl = row.querySelector('[name^="condition_value_"]');
    const value = valueEl ? valueEl.value : '';
    conditions.push({ field, operator, value });
  });

  const actions = [];
  document.querySelectorAll('.action-row').forEach(row => {
    const actionType = row.querySelector('select[name^="action_type_"]').value;
    const actionValueEl = row.querySelector('[name^="action_value_"]');
    const actionValue = actionValueEl ? actionValueEl.value : '';
    actions.push({ action_type: actionType, action_value: actionValue });
  });

  document.getElementById('test-results-card').style.display = 'block';
  document.getElementById('test-status').style.display = 'block';
  document.getElementById('test-error').style.display = 'none';
  document.getElementById('test-results-content').innerHTML = '';

  const startTime = Date.now();
  const progressInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    document.querySelector('#test-status i + span, #test-status').textContent = `Testing... (${elapsed}s elapsed)`;
  }, 1000);

  fetch('/rules/test-preview', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      credential_id: credentialId,
      logic: logic,
      conditions: conditions,
      actions: actions,
      max_emails: 10,
      monitored_folder: document.getElementById('monitored_folder').value
    })
  })
  .then(response => response.json())
  .then(data => {
    clearInterval(progressInterval);
    document.getElementById('test-status').style.display = 'none';

    if (data.error) {
      document.getElementById('test-error').style.display = 'block';
      document.getElementById('test-error').textContent = 'Error: ' + data.error;
      return;
    }

    const results = data.results;
    const emailsChecked = data.emails_checked || 'N/A';
    const totalEmails = data.total_emails || 'N/A';
    const inboxTotal = data.inbox_total || 'N/A';

    let html = `
      <div class="alert alert-info">
        <strong>Matching Emails:</strong> ${results.length} / 10 max<br>
        <strong>Emails Checked:</strong> ${emailsChecked} / ${totalEmails} (Inbox total: ${inboxTotal})
      </div>
      <table class="table table-striped">
        <thead><tr><th>Subject</th><th>From</th><th>Date</th><th>Details</th></tr></thead>
        <tbody>
    `;

    if (results.length === 0) {
      html += '<tr><td colspan="4" class="text-center">No matching emails found.</td></tr>';
    }

    results.forEach((result, index) => {
      html += `
        <tr>
          <td>${result.email_subject.substring(0, 50)}${result.email_subject.length > 50 ? '...' : ''}</td>
          <td>${result.email_from}</td>
          <td>${result.email_date}</td>
          <td>
            <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#details-${index}">
              <i class="bi bi-eye"></i> View
            </button>
          </td>
        </tr>
        <tr class="collapse" id="details-${index}">
          <td colspan="4"><div class="card card-body"><h6>Condition Results:</h6>
      `;

      result.condition_results.forEach(cond => {
        html += `
          <div class="mb-2">
            <strong>${cond.field}</strong> ${cond.operator} "${cond.value}":
            ${cond.matched ? '<span class="badge bg-success">Matched</span>' : '<span class="badge bg-secondary">Not Matched</span>'}
            <br><small class="text-muted">${cond.reason}</small>
          </div>
        `;
      });

      if (result.matched && result.actions_would_apply.length > 0) {
        html += '<h6 class="mt-3">Actions that would be applied:</h6><ul>';
        result.actions_would_apply.forEach(action => { html += `<li>${action}</li>`; });
        html += '</ul>';
      }

      html += '</div></td></tr>';
    });

    html += '</tbody></table>';
    document.getElementById('test-results-content').innerHTML = html;
  })
  .catch(error => {
    clearInterval(progressInterval);
    document.getElementById('test-status').style.display = 'none';
    document.getElementById('test-error').style.display = 'block';
    document.getElementById('test-error').textContent = 'Error: ' + error.message;
  });
}

// Load folders on page load
const currentFolder = "{{ rule.monitored_folder if rule.monitored_folder else 'INBOX' }}";

fetchFoldersIfNeeded()
  .then(folders => {
    const folderSelect = document.getElementById('monitored_folder');
    folderSelect.innerHTML = '';
    folders.forEach(folder => {
      if (folder.selectable) {
        const option = document.createElement('option');
        option.value = folder.name;
        option.textContent = folder.name;
        if (folder.name === currentFolder) option.selected = true;
        folderSelect.appendChild(option);
      }
    });
  })
  .catch(err => console.error('Error loading folders:', err));
</script>
{% endblock %}
