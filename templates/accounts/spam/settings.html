{% extends "base.html" %}

{% block title %}Spam Detection - {{ account.email_address }} - MailMind AI{% endblock %}

{% block page_title %}Spam Detection{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('list_accounts') }}">Email Accounts</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('account_dashboard', id=account.id) }}">{{ account.email_address }}</a></li>
<li class="breadcrumb-item active">Spam Detection</li>
{% endblock %}

{% block content %}
<section class="section">
  <div class="row">
    <div class="col-lg-8">

      <!-- Spam Detection Settings -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Spam Detection Settings</h5>

          <form method="POST" action="{{ url_for('account_spam_settings', id=account.id) }}">

            <div class="row mb-3">
              <label class="col-sm-3 col-form-label">Enable</label>
              <div class="col-sm-9">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="enabled" name="enabled"
                    {% if spam_config and spam_config.enabled %}checked{% endif %}>
                  <label class="form-check-label" for="enabled">Spam detection active</label>
                </div>
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-sm-3 col-form-label">LLM Provider</label>
              <div class="col-sm-9">
                {% if llm_configured %}
                  <span class="badge bg-success">Configured</span>
                  <small class="text-muted ms-2">LLM provider is configured for this account</small>
                  <div class="mt-2">
                    <a href="{{ url_for('account_llm_config', id=account.id) }}" class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-cpu"></i> Change LLM Provider
                    </a>
                  </div>
                {% else %}
                  <span class="badge bg-warning">Not Configured</span>
                  <small class="text-muted ms-2">Configure an LLM provider to enable spam detection</small>
                  <div class="mt-2">
                    <a href="{{ url_for('account_llm_config', id=account.id) }}" class="btn btn-sm btn-primary">
                      <i class="bi bi-cpu"></i> Configure LLM Provider
                    </a>
                  </div>
                {% endif %}
              </div>
            </div>

            <div class="row mb-3">
              <label for="sensitivity" class="col-sm-3 col-form-label">Sensitivity</label>
              <div class="col-sm-9">
                <input type="range" class="form-range" id="sensitivity" name="sensitivity"
                  min="1" max="10" value="{{ spam_config.sensitivity if spam_config else 5 }}"
                  oninput="document.getElementById('sensitivity-label').textContent = this.value">
                <div class="d-flex justify-content-between">
                  <small class="text-muted">1 - Lenient</small>
                  <strong id="sensitivity-label">{{ spam_config.sensitivity if spam_config else 5 }}</strong>
                  <small class="text-muted">10 - Strict</small>
                </div>
              </div>
            </div>

            <div class="row mb-3">
              <label for="spam_folder" class="col-sm-3 col-form-label">Spam Folder</label>
              <div class="col-sm-9">
                <input type="text" class="form-control" id="spam_folder" name="spam_folder"
                  value="{{ spam_config.spam_folder if spam_config else 'Spam' }}">
                <small class="text-muted">IMAP folder for spam emails (used in rules)</small>
              </div>
            </div>

            <div class="text-center">
              <button type="submit" class="btn btn-primary">Save Settings</button>
            </div>
          </form>

          {% if spam_config and spam_config.enabled %}
          <div class="alert alert-info mt-3">
            <h6><i class="bi bi-lightbulb"></i> Using Spam Detection</h6>
            <p class="mb-2">After spam analysis, emails will have <code>spam_score</code> and <code>spam_category</code> fields available for rules.</p>
            <p class="mb-2"><strong>Create your own rules to handle spam:</strong></p>
            <ul class="mb-2">
              <li>Example: <code>spam_score greater_than 0.7</code> → Move to Spam</li>
              <li>Example: <code>spam_category equals phishing</code> → Delete</li>
              <li>Example: <code>spam_category equals newsletter</code> → Move to Newsletters</li>
            </ul>
            <div class="mt-2">
              <a href="{{ url_for('account_add_rule', id=account.id) }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-circle"></i> Create Spam Rule
              </a>
              <a href="{{ url_for('account_rules', id=account.id) }}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-funnel"></i> View All Rules
              </a>
            </div>
          </div>
          {% endif %}

        </div>
      </div>

      <!-- Whitelist -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Whitelist (Trusted Domains)</h5>
          <p class="text-muted">Emails from these domains skip spam analysis and are marked as legitimate.</p>

          <div class="input-group mb-3">
            <input type="text" class="form-control" id="whitelist-domain" placeholder="example.com">
            <input type="text" class="form-control" id="whitelist-reason" placeholder="Reason (optional)">
            <button class="btn btn-success" type="button" onclick="addWhitelistDomain()">Add</button>
          </div>

          <div class="mb-3">
            <button class="btn btn-sm btn-outline-secondary" onclick="importDefaults()">Import Defaults (Google, Apple, Amazon, etc.)</button>
          </div>

          <div class="input-group mb-3">
            <input type="text" class="form-control" id="whitelist-import-url" placeholder="https://example.com/domains.txt">
            <button class="btn btn-outline-info" type="button" onclick="importFromUrl('whitelist')">
              <i class="bi bi-cloud-download"></i> Import from URL
            </button>
          </div>

          <table class="table table-sm table-hover" id="whitelist-table">
            <thead>
              <tr>
                <th>Domain</th>
                <th>Added</th>
                <th>Reason</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for entry in whitelist %}
              <tr id="wl-{{ entry.id }}">
                <td>{{ entry.domain }}</td>
                <td><small>{{ entry.added_at.strftime('%Y-%m-%d') if entry.added_at else 'N/A' }}</small></td>
                <td><small class="text-muted">{{ entry.reason or '' }}</small></td>
                <td>
                  <button class="btn btn-sm btn-danger" onclick="deleteWhitelist({{ entry.id }})">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
              {% else %}
              <tr id="wl-empty">
                <td colspan="4" class="text-center text-muted">No whitelisted domains.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Blacklist -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Blacklist (Blocked Domains)</h5>
          <p class="text-muted">Emails from these domains skip spam analysis and are marked as spam (score=1.0).</p>

          <div class="input-group mb-3">
            <input type="text" class="form-control" id="blacklist-domain" placeholder="example.com">
            <input type="text" class="form-control" id="blacklist-reason" placeholder="Reason (optional)">
            <button class="btn btn-danger" type="button" onclick="addBlacklistDomain()">Add</button>
          </div>

          <div class="input-group mb-3">
            <input type="text" class="form-control" id="blacklist-import-url" placeholder="https://example.com/domains.txt">
            <button class="btn btn-outline-info" type="button" onclick="importFromUrl('blacklist')">
              <i class="bi bi-cloud-download"></i> Import from URL
            </button>
          </div>

          <table class="table table-sm table-hover" id="blacklist-table">
            <thead>
              <tr>
                <th>Domain</th>
                <th>Added</th>
                <th>Reason</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for entry in blacklist %}
              <tr id="bl-{{ entry.id }}">
                <td>{{ entry.domain }}</td>
                <td><small>{{ entry.added_at.strftime('%Y-%m-%d') if entry.added_at else 'N/A' }}</small></td>
                <td><small class="text-muted">{{ entry.reason or '' }}</small></td>
                <td>
                  <button class="btn btn-sm btn-danger" onclick="deleteBlacklist({{ entry.id }})">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
              {% else %}
              <tr id="bl-empty">
                <td colspan="4" class="text-center text-muted">No blacklisted domains.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Quick Links</h5>
          <a href="{{ url_for('account_spam_log', id=account.id) }}" class="btn btn-sm btn-outline-info d-block mb-2">
            <i class="bi bi-journal-text"></i> Analysis Log
          </a>
          <a href="{{ url_for('account_rules', id=account.id) }}" class="btn btn-sm btn-outline-primary d-block mb-2">
            <i class="bi bi-funnel"></i> Rules
          </a>
          <a href="{{ url_for('account_dashboard', id=account.id) }}" class="btn btn-sm btn-outline-secondary d-block">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
          </a>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Spam Categories</h5>
          <ul class="list-unstyled">
            <li><span class="badge bg-success">legitimate</span> Normal correspondence</li>
            <li><span class="badge bg-info">newsletter</span> Opted-in newsletters</li>
            <li><span class="badge bg-secondary">commercial</span> Marketing/ads</li>
            <li><span class="badge bg-warning text-dark">spam</span> Unsolicited bulk mail</li>
            <li><span class="badge bg-danger">scam</span> Fraud attempts</li>
            <li><span class="badge bg-danger">phishing</span> Credential theft</li>
            <li><span class="badge bg-dark">malware</span> Malicious software</li>
            <li><span class="badge bg-secondary">adult</span> Adult content</li>
          </ul>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Usage with Rules</h5>
          <p class="small text-muted">
            When spam detection is enabled, auto-rules are created to sort detected spam into the configured folder. You can also create custom rules using <code>spam_score</code> and <code>spam_category</code> condition fields.
          </p>
          <p class="small text-muted">
            <strong>Auto-Categorize ON:</strong> 5 rules sort by category (Phishing, Scam, Spam, Malware, Adult) into subfolders.
          </p>
          <p class="small text-muted">
            <strong>Auto-Categorize OFF:</strong> 1 rule moves all spam (score &gt; 0.5) to the spam folder.
          </p>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
const credentialId = {{ account.id }};

function addWhitelistDomain() {
  const domain = document.getElementById('whitelist-domain').value.trim();
  const reason = document.getElementById('whitelist-reason').value.trim();
  if (!domain) { alert('Please enter a domain.'); return; }

  fetch(`/api/spam/whitelist/${credentialId}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({domain: domain, reason: reason})
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) { alert('Error: ' + data.error); return; }
    location.reload();
  })
  .catch(err => alert('Error: ' + err));
}

function deleteWhitelist(entryId) {
  if (!confirm('Remove this domain from whitelist?')) return;

  fetch(`/api/spam/whitelist/${entryId}`, {method: 'DELETE'})
    .then(r => r.json())
    .then(data => {
      if (data.error) { alert('Error: ' + data.error); return; }
      document.getElementById('wl-' + entryId).remove();
    })
    .catch(err => alert('Error: ' + err));
}

function addBlacklistDomain() {
  const domain = document.getElementById('blacklist-domain').value.trim();
  const reason = document.getElementById('blacklist-reason').value.trim();
  if (!domain) { alert('Please enter a domain.'); return; }

  fetch(`/api/spam/blacklist/${credentialId}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({domain: domain, reason: reason})
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) { alert('Error: ' + data.error); return; }
    location.reload();
  })
  .catch(err => alert('Error: ' + err));
}

function deleteBlacklist(entryId) {
  if (!confirm('Remove this domain from blacklist?')) return;

  fetch(`/api/spam/blacklist/${entryId}`, {method: 'DELETE'})
    .then(r => r.json())
    .then(data => {
      if (data.error) { alert('Error: ' + data.error); return; }
      document.getElementById('bl-' + entryId).remove();
    })
    .catch(err => alert('Error: ' + err));
}

function importFromUrl(listType) {
  const urlInput = document.getElementById(`${listType}-import-url`);
  const url = urlInput.value.trim();
  if (!url) { alert('Please enter a URL.'); return; }

  fetch(`/api/spam/${listType}/import-url/${credentialId}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({url: url})
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) { alert('Error: ' + data.error); return; }
    alert(`${data.added} domains imported, ${data.skipped} skipped (already exist).`);
    location.reload();
  })
  .catch(err => alert('Error: ' + err));
}

function importDefaults() {
  if (!confirm('Import default trusted domains (Google, Apple, Amazon, PayPal, etc.)?')) return;

  fetch(`/api/spam/whitelist/import-defaults/${credentialId}`, {method: 'POST'})
    .then(r => r.json())
    .then(data => {
      if (data.error) { alert('Error: ' + data.error); return; }
      alert(`${data.added} domains imported.`);
      location.reload();
    })
    .catch(err => alert('Error: ' + err));
}
</script>
{% endblock %}
