{% extends "base.html" %}

{% block title %}Spam Analysis Log - {{ account.email_address }} - MailMind AI{% endblock %}

{% block page_title %}Spam Analysis Log{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('list_accounts') }}">Email Accounts</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('account_dashboard', id=account.id) }}">{{ account.email_address }}</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('account_spam_settings', id=account.id) }}">Spam Detection</a></li>
<li class="breadcrumb-item active">Analysis Log</li>
{% endblock %}

{% block content %}
<section class="section">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Recent Spam Analysis</h5>

          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>Date</th>
                <th>Subject</th>
                <th>From</th>
                <th>Score</th>
                <th>Category</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {% for a in analyses %}
              <tr>
                <td><small>{{ a.analyzed_at.strftime('%Y-%m-%d %H:%M') if a.analyzed_at else 'N/A' }}</small></td>
                <td><small>{{ a.email_subject[:50] }}{% if a.email_subject|length > 50 %}...{% endif %}</small></td>
                <td><small>{{ a.email_from[:30] }}{% if a.email_from|length > 30 %}...{% endif %}</small></td>
                <td>
                  {% if a.spam_score is not none %}
                    <div class="progress" style="height: 20px; min-width: 80px;">
                      {% if a.spam_score < 0.3 %}
                        <div class="progress-bar bg-success" style="width: {{ (a.spam_score * 100)|round }}%">{{ '%.2f'|format(a.spam_score) }}</div>
                      {% elif a.spam_score < 0.7 %}
                        <div class="progress-bar bg-warning" style="width: {{ (a.spam_score * 100)|round }}%">{{ '%.2f'|format(a.spam_score) }}</div>
                      {% else %}
                        <div class="progress-bar bg-danger" style="width: {{ (a.spam_score * 100)|round }}%">{{ '%.2f'|format(a.spam_score) }}</div>
                      {% endif %}
                    </div>
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if a.spam_category == 'legitimate' %}
                    <span class="badge bg-success">{{ a.spam_category }}</span>
                  {% elif a.spam_category == 'newsletter' %}
                    <span class="badge bg-info">{{ a.spam_category }}</span>
                  {% elif a.spam_category == 'commercial' %}
                    <span class="badge bg-secondary">{{ a.spam_category }}</span>
                  {% elif a.spam_category == 'spam' %}
                    <span class="badge bg-warning text-dark">{{ a.spam_category }}</span>
                  {% elif a.spam_category in ['scam', 'phishing'] %}
                    <span class="badge bg-danger">{{ a.spam_category }}</span>
                  {% elif a.spam_category == 'malware' %}
                    <span class="badge bg-dark">{{ a.spam_category }}</span>
                  {% elif a.spam_category == 'adult' %}
                    <span class="badge bg-secondary">{{ a.spam_category }}</span>
                  {% else %}
                    <span class="badge bg-light text-dark">{{ a.spam_category or 'unknown' }}</span>
                  {% endif %}
                </td>
                <td>
                  {% if a.step_results %}
                  <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#steps-{{ a.id }}">
                    <i class="bi bi-eye"></i> {{ a.step_results|length }} steps
                  </button>
                  {% else %}
                    <small class="text-muted">No details</small>
                  {% endif %}
                </td>
              </tr>
              {% if a.step_results %}
              <tr class="collapse" id="steps-{{ a.id }}">
                <td colspan="6">
                  <div class="card card-body bg-light">
                    <table class="table table-sm mb-0">
                      <thead>
                        <tr>
                          <th>Step</th>
                          <th>Score</th>
                          <th>Category</th>
                          <th>Certain</th>
                          <th>Reasoning</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for step in a.step_results %}
                        <tr>
                          <td><strong>{{ step.step|capitalize }}</strong></td>
                          <td>{{ '%.2f'|format(step.score) }}</td>
                          <td><span class="badge bg-secondary">{{ step.category }}</span></td>
                          <td>
                            {% if step.is_certain %}
                              <span class="badge bg-success">Yes</span>
                            {% else %}
                              <span class="badge bg-light text-dark">No</span>
                            {% endif %}
                          </td>
                          <td><small>{{ step.reasoning }}</small></td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </td>
              </tr>
              {% endif %}
              {% else %}
              <tr>
                <td colspan="6" class="text-center text-muted">No spam analysis records found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}
