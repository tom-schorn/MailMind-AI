{% extends "base.html" %}

{% block content %}
<div class="pagetitle">
  <h1>LLM Configuration - {{ account.email_address }}</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('list_accounts') }}">Accounts</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('account_dashboard', id=account.id) }}">{{ account.email_address }}</a></li>
      <li class="breadcrumb-item active">LLM Configuration</li>
    </ol>
  </nav>
</div>

<section class="section">
  <div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">AI Provider Settings</h5>

          <form method="POST">
            <div class="mb-3">
              <label for="provider" class="form-label">Provider <span class="text-danger">*</span></label>
              <select name="provider" id="provider" class="form-select" required>
                <option value="claude" {% if llm_config and llm_config.provider == 'claude' %}selected{% endif %}>Claude (Anthropic)</option>
                <option value="gemini" {% if llm_config and llm_config.provider == 'gemini' %}selected{% endif %}>Gemini (Google)</option>
                <option value="openai" {% if llm_config and llm_config.provider == 'openai' %}selected{% endif %}>ChatGPT (OpenAI)</option>
                <option value="ollama" {% if llm_config and llm_config.provider == 'ollama' %}selected{% endif %}>Ollama (Self-hosted)</option>
              </select>
            </div>

            <div class="mb-3" id="api-key-field">
              <label for="api_key" class="form-label">API Key</label>
              <input type="password" name="api_key" id="api_key" class="form-control"
                     value="{{ llm_config.api_key if llm_config else '' }}"
                     placeholder="sk-ant-...">
              <div class="form-text">Not required for Ollama. Required for cloud providers.</div>
            </div>

            <div class="mb-3">
              <label for="model" class="form-label">Model <span class="text-danger">*</span></label>
              <select name="model" id="model" class="form-select" required>
                <!-- Options will be populated by JavaScript based on provider -->
              </select>
              <div class="form-text" id="model-help">Select a model for your provider</div>
            </div>

            <div class="mb-3" id="endpoint-field" style="display: none;">
              <label for="endpoint" class="form-label">Endpoint URL</label>
              <input type="text" name="endpoint" id="endpoint" class="form-control"
                     value="{{ llm_config.endpoint if llm_config else 'http://localhost:11434' }}"
                     placeholder="http://localhost:11434">
              <div class="form-text">Only for Ollama</div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle"></i> Save Configuration
              </button>
              <a href="{{ url_for('account_dashboard', id=account.id) }}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Help Sidebar -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">
            <i class="bi bi-question-circle"></i> Help & Information
          </h5>

          <h6>LLM Providers</h6>
          <p>MailMind supports multiple AI providers for spam analysis.</p>

          <h6 class="mt-3">Providers:</h6>
          <ul>
            <li><strong>Claude (Anthropic):</strong> Recommended, best accuracy
              <ul class="small">
                <li>Models: haiku (fast), sonnet (balanced)</li>
                <li>API Key: Get from console.anthropic.com</li>
              </ul>
            </li>
            <li><strong>Gemini (Google):</strong> Alternative with good performance
              <ul class="small">
                <li>API Key: Get from ai.google.dev</li>
              </ul>
            </li>
            <li><strong>ChatGPT (OpenAI):</strong> Popular general-purpose AI
              <ul class="small">
                <li>API Key: Get from platform.openai.com</li>
              </ul>
            </li>
            <li><strong>Ollama:</strong> Self-hosted, privacy-focused
              <ul class="small">
                <li>No API key needed</li>
                <li>Requires local Ollama installation</li>
              </ul>
            </li>
          </ul>

          <h6 class="mt-3">Cost Comparison:</h6>
          <ul class="small">
            <li><strong>Ollama:</strong> Free (self-hosted)</li>
            <li><strong>Claude Haiku:</strong> ~$0.0003/analysis</li>
            <li><strong>Gemini:</strong> ~$0.0002/analysis</li>
            <li><strong>GPT-3.5:</strong> ~$0.0005/analysis</li>
          </ul>

          <div class="alert alert-warning small mt-3">
            <i class="bi bi-shield-lock"></i>
            <strong>Privacy:</strong> API keys are stored in database. Use Ollama for full privacy.
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
// Model options per provider
const modelOptions = {
  claude: [
    { value: 'claude-haiku-4-5-20251001', label: 'Claude 4.5 Haiku (Fast, Recommended)' },
    { value: 'claude-sonnet-4-5-20250929', label: 'Claude 4.5 Sonnet (Accurate)' },
    { value: 'claude-opus-4-6', label: 'Claude 4.6 Opus (Most Capable)' }
  ],
  gemini: [
    { value: 'gemini-1.5-flash', label: 'Gemini 1.5 Flash (Fast)' },
    { value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro (Accurate)' },
    { value: 'gemini-2.0-flash-exp', label: 'Gemini 2.0 Flash (Experimental)' }
  ],
  openai: [
    { value: 'gpt-4o-mini', label: 'GPT-4o Mini (Fast, Recommended)' },
    { value: 'gpt-4o', label: 'GPT-4o (Accurate)' },
    { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo (Legacy)' }
  ],
  ollama: [
    { value: 'llama3.2:3b', label: 'Llama 3.2 3B (Fast)' },
    { value: 'llama3.2:1b', label: 'Llama 3.2 1B (Very Fast)' },
    { value: 'mistral:7b', label: 'Mistral 7B' },
    { value: 'phi3:mini', label: 'Phi-3 Mini' }
  ]
};

const currentModel = "{{ llm_config.model if llm_config else '' }}";

// Show/hide fields and populate models based on provider
document.getElementById('provider').addEventListener('change', function() {
  const provider = this.value;
  const apiKeyField = document.getElementById('api-key-field');
  const endpointField = document.getElementById('endpoint-field');
  const modelSelect = document.getElementById('model');

  // Show/hide fields
  if (provider === 'ollama') {
    apiKeyField.style.display = 'none';
    endpointField.style.display = 'block';
  } else {
    apiKeyField.style.display = 'block';
    endpointField.style.display = 'none';
  }

  // Populate model dropdown
  modelSelect.innerHTML = '';
  const models = modelOptions[provider] || [];
  models.forEach(model => {
    const option = document.createElement('option');
    option.value = model.value;
    option.textContent = model.label;
    if (model.value === currentModel) {
      option.selected = true;
    }
    modelSelect.appendChild(option);
  });

  // If current model not in list, add it as custom option
  if (currentModel && !models.find(m => m.value === currentModel)) {
    const option = document.createElement('option');
    option.value = currentModel;
    option.textContent = currentModel + ' (Custom)';
    option.selected = true;
    modelSelect.appendChild(option);
  }
});

// Trigger on load
document.getElementById('provider').dispatchEvent(new Event('change'));
</script>
{% endblock %}
